<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡¶™‡¶°‡¶º‡¶æ‡¶∞ ‡¶Ö‡¶ó‡ßç‡¶∞‡¶ó‡¶§‡¶ø ‡¶ü‡ßç‡¶∞‡ßç‡¶Ø‡¶æ‡¶ï‡¶æ‡¶∞</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        /* ‡¶á‡¶®‡ßç‡¶ü‡¶æ‡¶∞ (Inter) ‡¶´‡¶®‡ßç‡¶ü ‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞ ‡¶ï‡¶∞‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #1b7ddf; /* ‡¶π‡¶æ‡¶≤‡¶ï‡¶æ ‡¶¨‡ßç‡¶Ø‡¶æ‡¶ï‡¶ó‡ßç‡¶∞‡¶æ‡¶â‡¶®‡ßç‡¶° */
        }
        .card {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -2px rgba(0, 0, 0, 0.05);
        }
        .scroll-y {
            overflow-y: auto;
        }
        /* ‡¶ï‡¶æ‡¶∏‡ßç‡¶ü‡¶Æ ‡¶∏‡ßç‡¶ï‡ßç‡¶∞‡ßã‡¶≤‡¶¨‡¶æ‡¶∞ ‡¶∏‡ßç‡¶ü‡¶æ‡¶á‡¶≤ */
        .scroll-y::-webkit-scrollbar {
            width: 6px;
        }
        .scroll-y::-webkit-scrollbar-thumb {
            background-color: #a0aec0; /* ‡¶ó‡ßç‡¶∞‡ßá ‡¶ï‡¶æ‡¶≤‡¶æ‡¶∞ */
            border-radius: 3px;
        }
        .scroll-y::-webkit-scrollbar-track {
            background-color: #edf2f7; /* ‡¶π‡¶æ‡¶≤‡¶ï‡¶æ ‡¶ü‡ßç‡¶∞‡ßç‡¶Ø‡¶æ‡¶ï */
        }
    </style>
</head>
<body class="min-h-screen">

    <div id="app-container" class="max-w-7xl mx-auto p-4 sm:p-6 lg:p-8">

        <div id="loading-spinner" class="flex justify-center items-center min-h-screen">
            <svg class="animate-spin -ml-1 mr-3 h-8 w-8 text-indigo-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <span class="text-lg text-gray-700">‡¶Ö‡ßç‡¶Ø‡¶æ‡¶™‡ßç‡¶≤‡¶ø‡¶ï‡ßá‡¶∂‡¶® ‡¶≤‡ßã‡¶° ‡¶π‡¶ö‡ßç‡¶õ‡ßá...</span>
        </div>

        <div id="main-ui" class="hidden">
            
            <header class="flex justify-between items-center py-4 border-b border-gray-200 mb-6">
                <h1 class="text-3xl font-extrabold text-gray-900 flex items-center">
                    <i data-lucide="book-open-text" class="w-6 h-6 mr-3 text-indigo-600"></i>
                    ‡¶™‡¶°‡¶º‡¶æ‡¶∞ ‡¶ü‡ßç‡¶∞‡ßç‡¶Ø‡¶æ‡¶ï‡¶æ‡¶∞
                </h1>
                <div class="flex items-center space-x-4">
                    <p id="user-id-display" class="text-sm font-medium text-gray-500 bg-gray-100 px-3 py-1 rounded-full hidden sm:block">‡¶á‡¶â‡¶ú‡¶æ‡¶∞ ‡¶Ü‡¶á‡¶°‡¶ø: </p>
                    <button id="logout-button" class="flex items-center text-sm font-medium text-red-600 hover:text-red-700 transition duration-150 p-2 rounded-lg hover:bg-red-50">
                        <i data-lucide="log-out" class="w-5 h-5 mr-1"></i>
                        ‡¶≤‡¶ó‡¶Ü‡¶â‡¶ü
                    </button>
                </div>
            </header>

            <nav class="mb-6 flex space-x-4 border-b border-gray-200">
                <button data-view="dashboard" class="tab-button py-2 px-4 text-sm font-medium border-b-2 border-indigo-500 text-indigo-600 transition duration-150">‡¶°‡ßç‡¶Ø‡¶æ‡¶∂‡¶¨‡ßã‡¶∞‡ßç‡¶°</button>
                <button data-view="subjects" class="tab-button py-2 px-4 text-sm font-medium text-gray-500 hover:text-gray-700 hover:border-gray-300 transition duration-150">‡¶¨‡¶ø‡¶∑‡¶Ø‡¶º ‡¶ì ‡¶Ö‡¶ß‡ßç‡¶Ø‡¶æ‡¶Ø‡¶º</button>
                <button id="admin-tab-button" data-view="admin-panel" class="tab-button py-2 px-4 text-sm font-medium text-gray-500 hover:text-gray-700 hover:border-gray-300 transition duration-150 hidden">‡¶Ö‡ßç‡¶Ø‡¶æ‡¶°‡¶Æ‡¶ø‡¶® ‡¶™‡ßç‡¶Ø‡¶æ‡¶®‡ßá‡¶≤</button>
                <nav class="mb-6 flex space-x-4 border-b border-gray-200">
                <button data-view="dashboard" class="tab-button py-2 px-4 text-sm font-medium border-b-2 border-indigo-500 text-indigo-600 transition duration-150">‡¶°‡ßç‡¶Ø‡¶æ‡¶∂‡¶¨‡ßã‡¶∞‡ßç‡¶°</button>
                <button data-view="subjects" class="tab-button py-2 px-4 text-sm font-medium text-gray-500 hover:text-gray-700 hover:border-gray-300 transition duration-150">‡¶¨‡¶ø‡¶∑‡¶Ø‡¶º ‡¶ì ‡¶Ö‡¶ß‡ßç‡¶Ø‡¶æ‡¶Ø‡¶º</button>
                <button id="admin-tab-button" data-view="admin-panel" class="tab-button py-2 px-4 text-sm font-medium text-gray-500 hover:text-gray-700 hover:border-gray-300 transition duration-150 hidden">‡¶Ö‡ßç‡¶Ø‡¶æ‡¶°‡¶Æ‡¶ø‡¶®</button>
            </nav>
            </nav>

            <div id="view-container">
                <div id="dashboard-view" class="view-content grid grid-cols-1 lg:grid-cols-3 gap-6">
                    
                    <div class="lg:col-span-1 space-y-6">
                        <div id="timer-card" class="card bg-white p-6 rounded-xl">
                            <h2 class="text-xl font-semibold mb-4 text-gray-800 flex items-center">
                                <i data-lucide="timer" class="w-5 h-5 mr-2 text-indigo-500"></i>
                                ‡¶∞‡¶ø‡¶°‡¶ø‡¶Ç ‡¶ü‡¶æ‡¶á‡¶Æ‡¶æ‡¶∞
                            </h2>
                            <p id="timer-display" class="text-5xl font-bold text-center mb-6 text-indigo-700 tabular-nums">00:00:00</p>
                            
                            <select id="timer-subject-select" class="w-full p-3 mb-4 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 bg-white text-gray-700">
                                <option value="" disabled selected>‡¶¨‡¶ø‡¶∑‡ßü/‡¶Ö‡¶ß‡ßç‡¶Ø‡¶æ‡ßü ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®</option>
                            </select>

                            <div class="flex space-x-4">
                                <button id="timer-start-button" class="flex-1 bg-indigo-600 text-white font-semibold py-3 rounded-xl hover:bg-indigo-700 transition duration-150">
                                    <i data-lucide="play" class="w-5 h-5 inline-block mr-1"></i>
                                    ‡¶∂‡ßÅ‡¶∞‡ßÅ ‡¶ï‡¶∞‡ßÅ‡¶®
                                </button>
                                <button id="timer-stop-button" class="flex-1 bg-red-500 text-white font-semibold py-3 rounded-xl hover:bg-red-600 transition duration-150" disabled>
                                    <i data-lucide="square" class="w-5 h-5 inline-block mr-1"></i>
                                    ‡¶¨‡¶®‡ßç‡¶ß ‡¶ï‡¶∞‡ßÅ‡¶®
                                </button>
                            </div>
                        </div>

                        <div id="routine-card" class="card bg-white p-6 rounded-xl">
                            <h2 class="text-xl font-semibold mb-4 text-gray-800 flex items-center">
                                <i data-lucide="list-checks" class="w-5 h-5 mr-2 text-green-500"></i>
                                ‡¶Ü‡¶ú‡¶ï‡ßá‡¶∞ ‡¶™‡¶°‡¶º‡¶æ‡¶∞ ‡¶∞‡ßÅ‡¶ü‡¶ø‡¶®
                            </h2>
                            <div id="routine-list" class="space-y-3">
                                <p class="text-sm text-gray-500">‡¶Ü‡¶ú‡¶ï‡ßá‡¶∞ ‡¶ï‡ßã‡¶®‡ßã ‡¶∞‡ßÅ‡¶ü‡¶ø‡¶® ‡¶∏‡ßá‡¶ü ‡¶ï‡¶∞‡¶æ ‡¶®‡ßá‡¶á‡•§</p>
                            </div>
                            <form id="routine-form" class="mt-4 border-t pt-4">
                                <h3 class="font-medium mb-2">‡¶®‡¶§‡ßÅ‡¶® ‡¶∞‡ßÅ‡¶ü‡¶ø‡¶® ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡ßÅ‡¶®:</h3>
                                <select id="routine-subject-select" class="w-full p-2 mb-2 border border-gray-300 rounded-lg text-sm">
                                    <option value="" disabled selected>‡¶¨‡¶ø‡¶∑‡ßü ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®</option>
                                </select>
                                <input type="number" id="routine-duration-input" placeholder="‡¶≤‡¶ï‡ßç‡¶∑‡ßç‡¶Ø ‡¶Æ‡¶ø‡¶®‡¶ø‡¶ü (‡¶Ø‡ßá‡¶Æ‡¶®: ‡ß©‡ß¶)" class="w-full p-2 mb-2 border border-gray-300 rounded-lg text-sm" min="1">
                                <button type="submit" class="w-full bg-green-500 text-white text-sm font-semibold py-2 rounded-lg hover:bg-green-600 transition duration-150">‡¶∞‡ßÅ‡¶ü‡¶ø‡¶® ‡¶∏‡ßá‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®</button>
                            </form>
                        </div>

                    </div>

                    <div class="lg:col-span-2 space-y-6">
                        <div class="card bg-white p-6 rounded-xl">
                            <h2 class="text-xl font-semibold mb-4 text-gray-800 flex items-center">
                                <i data-lucide="bar-chart-3" class="w-5 h-5 mr-2 text-purple-500"></i>
                                ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶™‡¶∞‡¶ø‡¶∏‡¶Ç‡¶ñ‡ßç‡¶Ø‡¶æ‡¶®
                            </h2>
                            <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 mb-6">
                                <div class="bg-indigo-50 p-4 rounded-lg">
                                    <p class="text-sm font-medium text-gray-500">‡¶Æ‡ßã‡¶ü ‡¶™‡¶°‡¶º‡¶æ‡¶∞ ‡¶∏‡¶Æ‡¶Ø‡¶º</p>
                                    <p id="total-reading-time" class="text-2xl font-bold text-indigo-800">0 ‡¶ò‡¶£‡ßç‡¶ü‡¶æ</p>
                                </div>
                                <div class="bg-green-50 p-4 rounded-lg">
                                    <p class="text-sm font-medium text-gray-500">‡¶Ü‡¶ú‡¶ï‡ßá‡¶∞ ‡¶™‡¶°‡¶º‡¶æ</p>
                                    <p id="daily-reading-time" class="text-2xl font-bold text-green-800">0 ‡¶Æ‡¶ø‡¶®‡¶ø‡¶ü</p>
                                </div>
                                <div class="bg-yellow-50 p-4 rounded-lg">
                                    <p class="text-sm font-medium text-gray-500">‡¶∏‡¶æ‡¶™‡ßç‡¶§‡¶æ‡¶π‡¶ø‡¶ï ‡¶™‡¶°‡¶º‡¶æ</p>
                                    <p id="weekly-reading-time" class="text-2xl font-bold text-yellow-800">0 ‡¶ò‡¶£‡ßç‡¶ü‡¶æ</p>
                                </div>
                            </div>

                            <h3 class="text-lg font-medium text-gray-700 mb-3">‡¶∏‡¶æ‡¶™‡ßç‡¶§‡¶æ‡¶π‡¶ø‡¶ï ‡¶ï‡¶æ‡¶∞‡ßç‡¶Ø‡¶ï‡¶≤‡¶æ‡¶™ (‡¶Æ‡¶ø‡¶®‡¶ø‡¶ü‡ßá)</h3>
                            <canvas id="weeklyActivityChart" height="150"></canvas>
                            
                            <form id="goal-form" class="mt-6 pt-4 border-t">
                                <h3 class="font-medium mb-2">‡¶¶‡ßà‡¶®‡¶ø‡¶ï ‡¶ì ‡¶∏‡¶æ‡¶™‡ßç‡¶§‡¶æ‡¶π‡¶ø‡¶ï ‡¶≤‡¶ï‡ßç‡¶∑‡ßç‡¶Ø ‡¶∏‡ßá‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®</h3>
                                <div class="flex space-x-3">
                                    <input type="number" id="daily-goal-input" placeholder="‡¶¶‡ßà‡¶®‡¶ø‡¶ï ‡¶≤‡¶ï‡ßç‡¶∑‡ßç‡¶Ø (‡¶Æ‡¶ø‡¶®‡¶ø‡¶ü)" class="flex-1 p-2 border border-gray-300 rounded-lg text-sm" min="1">
                                    <input type="number" id="weekly-goal-input" placeholder="‡¶∏‡¶æ‡¶™‡ßç‡¶§‡¶æ‡¶π‡¶ø‡¶ï ‡¶≤‡¶ï‡ßç‡¶∑‡ßç‡¶Ø (‡¶ò‡¶®‡ßç‡¶ü‡¶æ)" class="flex-1 p-2 border border-gray-300 rounded-lg text-sm" min="1">
                                    <button type="submit" class="bg-indigo-500 text-white text-sm font-semibold px-4 py-2 rounded-lg hover:bg-indigo-600 transition duration-150">‡¶∏‡ßá‡¶≠ ‡¶ï‡¶∞‡ßÅ‡¶®</button>
                                </div>
                            </form>
                        </div>
                        
                        <div class="card bg-white p-6 rounded-xl">
                            <h2 class="text-xl font-semibold mb-4 text-gray-800 flex items-center">
                                <i data-lucide="calendar-check" class="w-5 h-5 mr-2 text-teal-500"></i>
                                ‡¶ï‡¶æ‡¶∏‡ßç‡¶ü‡¶Æ ‡¶™‡¶°‡¶º‡¶æ‡¶∞ ‡¶™‡¶∞‡¶ø‡¶ï‡¶≤‡ßç‡¶™‡¶®‡¶æ
                            </h2>
                            <form id="plan-form" class="space-y-3">
                                <select id="plan-subject-select" class="w-full p-3 border border-gray-300 rounded-lg text-gray-700">
                                    <option value="" disabled selected>‡¶™‡¶∞‡¶ø‡¶ï‡¶≤‡ßç‡¶™‡¶®‡¶æ‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶¨‡¶ø‡¶∑‡¶Ø‡¶º ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®</option>
                                </select>
                                <input type="number" id="plan-days-input" placeholder="‡¶ï‡¶§ ‡¶¶‡¶ø‡¶®‡ßá ‡¶¨‡¶á‡¶ü‡¶ø ‡¶∂‡ßá‡¶∑ ‡¶ï‡¶∞‡¶§‡ßá ‡¶ö‡¶æ‡¶®? (‡¶¶‡¶ø‡¶®)" class="w-full p-3 border border-gray-300 rounded-lg" min="1" required>
                                <button type="submit" class="w-full bg-teal-500 text-white font-semibold py-3 rounded-lg hover:bg-teal-600 transition duration-150">‡¶™‡¶∞‡¶ø‡¶ï‡¶≤‡ßç‡¶™‡¶®‡¶æ ‡¶§‡ßà‡¶∞‡¶ø ‡¶ï‡¶∞‡ßÅ‡¶®</button>
                            </form>
                            <div id="plan-output" class="mt-4 pt-4 border-t hidden">
                                <p class="text-base font-medium text-gray-700 mb-2">‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶™‡¶°‡¶º‡¶æ‡¶∞ ‡¶™‡¶∞‡¶ø‡¶ï‡¶≤‡ßç‡¶™‡¶®‡¶æ:</p>
                                <p id="plan-details" class="text-lg font-bold text-teal-700"></p>
                                <p id="plan-daily-chapters" class="text-sm text-gray-600"></p>
                            </div>
                        </div>

                    </div>
                </div>

                <div id="subjects-view" class="view-content hidden space-y-6">
                    <div class="card bg-white p-6 rounded-xl">
                        <h2 class="text-2xl font-semibold mb-4 text-gray-800 flex items-center">
                            <i data-lucide="book-open" class="w-6 h-6 mr-2 text-indigo-500"></i>
                            ‡¶¨‡¶ø‡¶∑‡¶Ø‡¶º ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡ßÅ‡¶®
                        </h2>
                        <form id="subject-form" class="flex space-x-3">
                            <input type="text" id="subject-name-input" placeholder="‡¶®‡¶§‡ßÅ‡¶® ‡¶¨‡¶ø‡¶∑‡¶Ø‡¶º‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ (‡¶Ø‡ßá‡¶Æ‡¶®: ‡¶¨‡¶æ‡¶Ç‡¶≤‡¶æ)" class="flex-1 p-3 border border-gray-300 rounded-lg" required>
                            <button type="submit" class="bg-indigo-600 text-white font-semibold px-6 py-3 rounded-lg hover:bg-indigo-700 transition duration-150">‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡ßÅ‡¶®</button>
                        </form>
                    </div>

                    <div class="card bg-white p-6 rounded-xl">
                        <h2 class="text-2xl font-semibold mb-4 text-gray-800 flex items-center">
                            <i data-lucide="library" class="w-6 h-6 mr-2 text-indigo-500"></i>
                            ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶¨‡¶ø‡¶∑‡¶Ø‡¶º ‡¶§‡¶æ‡¶≤‡¶ø‡¶ï‡¶æ
                        </h2>
                        <div id="subjects-list" class="space-y-4">
                            <p class="text-gray-500">‡¶ï‡ßã‡¶®‡ßã ‡¶¨‡¶ø‡¶∑‡¶Ø‡¶º ‡¶≤‡ßã‡¶° ‡¶π‡¶Ø‡¶º‡¶®‡¶ø‡•§</p>
                        </div>
                    </div>
                </div>

                <div id="admin-panel-view" class="view-content hidden space-y-6">
                    <h2 class="text-3xl font-bold text-gray-900 flex items-center">
                        <i data-lucide="shield" class="w-7 h-7 mr-2 text-red-500"></i>
                        ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶°‡¶Æ‡¶ø‡¶® ‡¶™‡ßç‡¶Ø‡¶æ‡¶®‡ßá‡¶≤
                    </h2>
                    <div class="card bg-white p-6 rounded-xl">
                        <h3 class="text-xl font-semibold mb-4 text-gray-800">‡¶∏‡¶ï‡¶≤ ‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞‡¶ï‡¶æ‡¶∞‡ßÄ‡¶∞ ‡¶™‡¶°‡¶º‡¶æ‡¶∞ ‡¶™‡¶∞‡¶ø‡¶∏‡¶Ç‡¶ñ‡ßç‡¶Ø‡¶æ‡¶®</h3>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                            <div class="bg-red-50 p-4 rounded-lg">
                                <p class="text-sm font-medium text-gray-500">‡¶Æ‡ßã‡¶ü ‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞‡¶ï‡¶æ‡¶∞‡ßÄ</p>
                                <p id="admin-user-count" class="text-2xl font-bold text-red-800">...</p>
                            </div>
                            <div class="bg-blue-50 p-4 rounded-lg">
                                <p class="text-sm font-medium text-gray-500">‡¶Æ‡ßã‡¶ü ‡¶™‡¶°‡¶º‡¶æ‡¶∞ ‡¶∏‡¶Æ‡¶Ø‡¶º (‡¶ò‡¶£‡ßç‡¶ü‡¶æ)</p>
                                <p id="admin-total-hours" class="text-2xl font-bold text-blue-800">...</p>
                            </div>
                            <div class="bg-purple-50 p-4 rounded-lg">
                                <p class="text-sm font-medium text-gray-500">‡¶∏‡¶æ‡¶™‡ßç‡¶§‡¶æ‡¶π‡¶ø‡¶ï ‡¶ó‡¶°‡¶º</p>
                                <p id="admin-weekly-avg" class="text-2xl font-bold text-purple-800">...</p>
                            </div>
                        </div>

                        <h3 class="text-lg font-medium text-gray-700 mb-3">‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞‡¶ï‡¶æ‡¶∞‡ßÄ ‡¶ï‡¶æ‡¶∞‡ßç‡¶Ø‡¶ï‡¶≤‡¶æ‡¶™ ‡¶∞‡¶ø‡¶™‡ßã‡¶∞‡ßç‡¶ü</h3>
                        <div class="scroll-y h-96 border rounded-lg p-4">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50 sticky top-0">
                                    <tr>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">‡¶á‡¶â‡¶ú‡¶æ‡¶∞ ‡¶Ü‡¶á‡¶°‡¶ø</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">‡¶Æ‡ßã‡¶ü ‡¶∏‡¶Æ‡¶Ø‡¶º (‡¶ò‡¶£‡ßç‡¶ü‡¶æ)</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">‡¶∏‡¶∞‡ßç‡¶¨‡¶∂‡ßá‡¶∑ ‡¶ï‡¶æ‡¶∞‡ßç‡¶Ø‡¶ï‡¶≤‡¶æ‡¶™</th>
                                    </tr>
                                </thead>
                                <tbody id="admin-user-report-table" class="bg-white divide-y divide-gray-200">
                                    </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- =========== STREAKS VIEW =========== -->
<div id="streaks-view" class="view-content hidden space-y-6">
    <div class="card bg-white p-6 rounded-xl">
        <h2 class="text-2xl font-semibold mb-6 text-gray-800 flex items-center">
            <i data-lucide="flame" class="w-6 h-6 mr-2 text-red-500"></i>
            ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶™‡¶°‡¶º‡¶æ‡¶∞ ‡¶∏‡ßç‡¶ü‡ßç‡¶∞‡¶ø‡¶ï
        </h2>
        
        <!-- Current Streak -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8">
            <div class="bg-gradient-to-br from-red-50 to-orange-50 p-6 rounded-lg border border-red-200">
                <p class="text-sm font-medium text-gray-600 mb-2">‡¶¨‡¶∞‡ßç‡¶§‡¶Æ‡¶æ‡¶® ‡¶∏‡ßç‡¶ü‡ßç‡¶∞‡¶ø‡¶ï</p>
                <div class="flex items-center">
                    <span id="current-streak" class="text-4xl font-bold text-red-600">0</span>
                    <span class="text-3xl ml-2">üî•</span>
                </div>
                <p class="text-xs text-gray-500 mt-2">‡¶ß‡¶æ‡¶∞‡¶æ‡¶¨‡¶æ‡¶π‡¶ø‡¶ï ‡¶¶‡¶ø‡¶®</p>
            </div>
            
            <div class="bg-gradient-to-br from-yellow-50 to-amber-50 p-6 rounded-lg border border-yellow-200">
                <p class="text-sm font-medium text-gray-600 mb-2">‡¶∏‡¶∞‡ßç‡¶¨‡ßã‡¶ö‡ßç‡¶ö ‡¶∏‡ßç‡¶ü‡ßç‡¶∞‡¶ø‡¶ï</p>
                <div class="flex items-center">
                    <span id="longest-streak" class="text-4xl font-bold text-yellow-600">0</span>
                    <span class="text-3xl ml-2">‚≠ê</span>
                </div>
                <p class="text-xs text-gray-500 mt-2">‡¶Ü‡¶ó‡ßá ‡¶Ö‡¶∞‡ßç‡¶ú‡¶ø‡¶§</p>
            </div>
            
            <div class="bg-gradient-to-br from-green-50 to-teal-50 p-6 rounded-lg border border-green-200">
                <p class="text-sm font-medium text-gray-600 mb-2">‡¶Æ‡ßã‡¶ü ‡¶™‡¶°‡¶º‡¶æ‡¶∞ ‡¶¶‡¶ø‡¶®</p>
                <div class="flex items-center">
                    <span id="total-reading-days" class="text-4xl font-bold text-green-600">0</span>
                    <span class="text-3xl ml-2">üìö</span>
                </div>
                <p class="text-xs text-gray-500 mt-2">‡¶∏‡¶¨ ‡¶∏‡¶Æ‡¶Ø‡¶º‡ßá</p>
            </div>
        </div>
        
        <!-- Streak Warning -->
        <div id="streak-warning" class="hidden bg-yellow-50 border border-yellow-200 rounded-lg p-4 mb-6">
            <p class="text-sm text-yellow-800">
                <i data-lucide="alert-circle" class="w-4 h-4 inline-block mr-2"></i>
                <strong>‡¶∏‡¶§‡¶∞‡ßç‡¶ï‡¶§‡¶æ:</strong> ‡¶Ü‡¶ó‡¶æ‡¶Æ‡ßÄ‡¶ï‡¶æ‡¶≤ ‡¶∏‡ßç‡¶ü‡ßç‡¶∞‡¶ø‡¶ï ‡¶≠‡¶æ‡¶ô‡ßç‡¶ó‡¶¨‡ßá!  ‡¶Ü‡¶ú ‡¶™‡¶°‡¶º‡ßÅ‡¶®!
            </p>
        </div>
        
        <!-- Streak History -->
        <h3 class="text-lg font-semibold text-gray-700 mb-4">‡¶∏‡ßç‡¶ü‡ßç‡¶∞‡¶ø‡¶ï ‡¶á‡¶§‡¶ø‡¶π‡¶æ‡¶∏</h3>
        <div class="overflow-x-auto">
            <table class="w-full text-sm">
                <thead>
                    <tr class="border-b border-gray-200">
                        <th class="text-left px-4 py-3 font-medium text-gray-600">‡¶Æ‡¶æ‡¶∏</th>
                        <th class="text-left px-4 py-3 font-medium text-gray-600">‡¶∏‡ßç‡¶ü‡ßç‡¶∞‡¶ø‡¶ï</th>
                        <th class="text-left px-4 py-3 font-medium text-gray-600">‡¶∂‡ßÅ‡¶∞‡ßÅ</th>
                        <th class="text-left px-4 py-3 font-medium text-gray-600">‡¶∂‡ßá‡¶∑</th>
                    </tr>
                </thead>
                <tbody id="streak-history-table">
                    <tr>
                        <td colspan="4" class="text-center py-4 text-gray-500">‡¶ï‡ßã‡¶®‡ßã ‡¶°‡ßá‡¶ü‡¶æ ‡¶®‡ßá‡¶á</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- =========== CALENDAR VIEW =========== -->
<div id="calendar-view" class="view-content hidden space-y-6">
    <div class="card bg-white p-6 rounded-xl">
        <h2 class="text-2xl font-semibold mb-6 text-gray-800 flex items-center">
            <i data-lucide="calendar" class="w-6 h-6 mr-2 text-blue-500"></i>
            ‡¶™‡¶°‡¶º‡¶æ‡¶∞ ‡¶ï‡ßç‡¶Ø‡¶æ‡¶≤‡ßá‡¶®‡ßç‡¶°‡¶æ‡¶∞
        </h2>
        
        <!-- Month Navigation -->
        <div class="flex justify-between items-center mb-6">
            <button id="prev-month-btn" class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">
                <i data-lucide="chevron-left" class="w-4 h-4 inline-block"></i> ‡¶™‡ßÇ‡¶∞‡ßç‡¶¨‡¶¨‡¶∞‡ßç‡¶§‡ßÄ
            </button>
            <h3 id="calendar-month-year" class="text-xl font-semibold text-gray-800">‡¶°‡¶ø‡¶∏‡ßá‡¶Æ‡ßç‡¶¨‡¶∞ ‡ß®‡ß¶‡ß®‡ß´</h3>
            <button id="next-month-btn" class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">
                ‡¶™‡¶∞‡¶¨‡¶∞‡ßç‡¶§‡ßÄ <i data-lucide="chevron-right" class="w-4 h-4 inline-block"></i>
            </button>
        </div>
        
        <!-- Calendar Grid -->
        <div class="grid grid-cols-7 gap-2 mb-6">
            <!-- Days of week header -->
            <div class="text-center font-bold text-gray-600 py-2">‡¶∏‡ßã‡¶Æ</div>
            <div class="text-center font-bold text-gray-600 py-2">‡¶Æ‡¶ô‡ßç‡¶ó‡¶≤</div>
            <div class="text-center font-bold text-gray-600 py-2">‡¶¨‡ßÅ‡¶ß</div>
            <div class="text-center font-bold text-gray-600 py-2">‡¶¨‡ßÉ‡¶π‡¶É</div>
            <div class="text-center font-bold text-gray-600 py-2">‡¶∂‡ßÅ‡¶ï‡ßç‡¶∞</div>
            <div class="text-center font-bold text-gray-600 py-2">‡¶∂‡¶®‡¶ø</div>
            <div class="text-center font-bold text-gray-600 py-2">‡¶∞‡¶¨‡¶ø</div>
            
            <!-- Calendar days -->
            <div id="calendar-grid" class="col-span-7 grid grid-cols-7 gap-2">
                <!-- Generated by JavaScript -->
            </div>
        </div>
        
        <!-- Calendar Legend -->
        <div class="bg-gray-50 p-4 rounded-lg border border-gray-200">
            <p class="text-sm font-medium text-gray-700 mb-3">‡¶∞‡¶ô‡ßá‡¶∞ ‡¶Ö‡¶∞‡ßç‡¶•:</p>
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                <div class="flex items-center">
                    <div class="w-4 h-4 bg-green-500 rounded mr-2"></div>
                    <span class="text-sm text-gray-600">‡¶™‡¶°‡¶º‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá ‚úì</span>
                </div>
                <div class="flex items-center">
                    <div class="w-4 h-4 bg-yellow-500 rounded mr-2"></div>
                    <span class="text-sm text-gray-600">‡¶ï‡¶Æ ‡¶™‡¶°‡¶º‡¶æ</span>
                </div>
                <div class="flex items-center">
                    <div class="w-4 h-4 bg-red-500 rounded mr-2"></div>
                    <span class="text-sm text-gray-600">‡¶™‡¶°‡¶º‡¶æ ‡¶π‡¶Ø‡¶º‡¶®‡¶ø ‚úó</span>
                </div>
                <div class="flex items-center">
                    <div class="w-4 h-4 bg-gray-300 rounded mr-2"></div>
                    <span class="text-sm text-gray-600">‡¶Ö‡¶®‡ßç‡¶Ø ‡¶Æ‡¶æ‡¶∏</span>
                </div>
            </div>
        </div>
        
        <!-- Day Details -->
        <div id="day-details" class="mt-6 hidden p-4 bg-blue-50 rounded-lg border border-blue-200">
            <h4 class="font-semibold text-gray-800 mb-2">‡¶¶‡¶ø‡¶®‡ßá‡¶∞ ‡¶¨‡¶ø‡¶¨‡¶∞‡¶£:</h4>
            <p id="day-reading-time" class="text-sm text-gray-600 mb-1">‡¶™‡¶°‡¶º‡¶æ‡¶∞ ‡¶∏‡¶Æ‡¶Ø‡¶º: <span class="font-semibold">0 ‡¶ò‡¶£‡ßç‡¶ü‡¶æ</span></p>
            <p id="day-sessions" class="text-sm text-gray-600">‡¶∏‡ßá‡¶∂‡¶® ‡¶∏‡¶Ç‡¶ñ‡ßç‡¶Ø‡¶æ: <span class="font-semibold">0</span></p>
        </div>
    </div>
</div>

<!-- =========== HISTORY VIEW =========== -->
<div id="history-view" class="view-content hidden space-y-6">
    <div class="card bg-white p-6 rounded-xl">
        <h2 class="text-2xl font-semibold mb-6 text-gray-800 flex items-center">
            <i data-lucide="history" class="w-6 h-6 mr-2 text-purple-500"></i>
            ‡¶™‡¶°‡¶º‡¶æ‡¶∞ ‡¶á‡¶§‡¶ø‡¶π‡¶æ‡¶∏
        </h2>
        
        <!-- Filters -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">‡¶¨‡¶ø‡¶∑‡¶Ø‡¶º ‡¶´‡¶ø‡¶≤‡ßç‡¶ü‡¶æ‡¶∞ ‡¶ï‡¶∞‡ßÅ‡¶®</label>
                <select id="history-subject-filter" class="w-full p-2 border border-gray-300 rounded-lg text-sm">
                    <option value="">‡¶∏‡¶¨ ‡¶¨‡¶ø‡¶∑‡¶Ø‡¶º</option>
                </select>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">‡¶∂‡ßÅ‡¶∞‡ßÅ‡¶∞ ‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ</label>
                <input type="date" id="history-start-date" class="w-full p-2 border border-gray-300 rounded-lg text-sm">
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">‡¶∂‡ßá‡¶∑ ‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ</label>
                <input type="date" id="history-end-date" class="w-full p-2 border border-gray-300 rounded-lg text-sm">
            </div>
            <div class="flex items-end">
                <button id="history-filter-btn" class="w-full px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 text-sm font-medium">
                    ‡¶´‡¶ø‡¶≤‡ßç‡¶ü‡¶æ‡¶∞ ‡¶ï‡¶∞‡ßÅ‡¶®
                </button>
            </div>
        </div>
        
        <!-- Summary Stats -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
            <div class="bg-blue-50 p-4 rounded-lg border border-blue-200">
                <p class="text-xs font-medium text-gray-600">‡¶Æ‡ßã‡¶ü ‡¶∏‡ßá‡¶∂‡¶®</p>
                <p id="history-total-sessions" class="text-2xl font-bold text-blue-600">0</p>
            </div>
            <div class="bg-green-50 p-4 rounded-lg border border-green-200">
                <p class="text-xs font-medium text-gray-600">‡¶Æ‡ßã‡¶ü ‡¶∏‡¶Æ‡¶Ø‡¶º</p>
                <p id="history-total-time" class="text-2xl font-bold text-green-600">0 ‡¶ò</p>
            </div>
            <div class="bg-purple-50 p-4 rounded-lg border border-purple-200">
                <p class="text-xs font-medium text-gray-600">‡¶ó‡¶°‡¶º ‡¶∏‡ßá‡¶∂‡¶®</p>
                <p id="history-avg-session" class="text-2xl font-bold text-purple-600">0 ‡¶Æ‡¶ø</p>
            </div>
            <div class="bg-orange-50 p-4 rounded-lg border border-orange-200">
                <p class="text-xs font-medium text-gray-600">‡¶∏‡¶¨‡¶ö‡ßá‡¶Ø‡¶º‡ßá ‡¶¶‡ßÄ‡¶∞‡ßç‡¶ò</p>
                <p id="history-longest-session" class="text-2xl font-bold text-orange-600">0 ‡¶Æ‡¶ø</p>
            </div>
        </div>
        
        <!-- Sessions Table -->
        <div class="overflow-x-auto">
            <table class="w-full text-sm border-collapse">
                <thead>
                    <tr class="bg-gray-50 border-b-2 border-gray-200">
                        <th class="px-4 py-3 text-left font-medium text-gray-700">‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ</th>
                        <th class="px-4 py-3 text-left font-medium text-gray-700">‡¶¨‡¶ø‡¶∑‡¶Ø‡¶º/‡¶Ö‡¶ß‡ßç‡¶Ø‡¶æ‡¶Ø‡¶º</th>
                        <th class="px-4 py-3 text-left font-medium text-gray-700">‡¶∏‡¶Æ‡¶Ø‡¶º</th>
                        <th class="px-4 py-3 text-left font-medium text-gray-700">‡¶∏‡¶Æ‡¶Ø‡¶º‡¶ï‡¶æ‡¶≤</th>
                        <th class="px-4 py-3 text-center font-medium text-gray-700">‡¶Ö‡ßç‡¶Ø‡¶æ‡¶ï‡¶∂‡¶®</th>
                    </tr>
                </thead>
                <tbody id="history-table-body">
                    <tr>
                        <td colspan="5" class="px-4 py-8 text-center text-gray-500">‡¶ï‡ßã‡¶®‡ßã ‡¶∞‡ßá‡¶ï‡¶∞‡ßç‡¶° ‡¶®‡ßá‡¶á</td>
                    </tr>
                </tbody>
            </table>
        </div>
        
        <!-- Pagination -->
        <div class="flex justify-between items-center mt-6">
            <button id="history-prev-page" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300 disabled:opacity-50">
                ‡¶™‡ßÇ‡¶∞‡ßç‡¶¨‡¶¨‡¶∞‡ßç‡¶§‡ßÄ
            </button>
            <span id="history-page-info" class="text-sm text-gray-600">‡¶™‡ßÉ‡¶∑‡ßç‡¶†‡¶æ 1 / 1</span>
            <button id="history-next-page" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300 disabled:opacity-50">
                ‡¶™‡¶∞‡¶¨‡¶∞‡ßç‡¶§‡ßÄ
            </button>
        </div>
        </div>
        </div>



            </div>

        </div>

        <div id="auth-view" class="hidden min-h-screen flex justify-center items-center">
            <div class="card bg-white p-8 rounded-xl w-full max-w-md">
                <h2 class="text-2xl font-bold text-center mb-6 text-gray-900">‡¶≤‡¶ó‡¶á‡¶® / ‡¶∏‡¶æ‡¶á‡¶® ‡¶Ü‡¶™</h2>
                <form id="auth-form" class="space-y-4">
                    <div>
                        <label for="email" class="block text-sm font-medium text-gray-700">‡¶á‡¶Æ‡ßá‡¶á‡¶≤</label>
                        <input type="email" id="email" required class="mt-1 block w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                    <div>
                        <label for="password" class="block text-sm font-medium text-gray-700">‡¶™‡¶æ‡¶∏‡¶ì‡¶Ø‡¶º‡¶æ‡¶∞‡ßç‡¶°</label>
                        <input type="password" id="password" required class="mt-1 block w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                    <p id="auth-error" class="text-sm text-red-500 text-center"></p>
                    <button type="submit" id="auth-submit-button" class="w-full bg-indigo-600 text-white font-semibold py-3 rounded-lg hover:bg-indigo-700 transition duration-150">
                        ‡¶≤‡¶ó‡¶á‡¶® / ‡¶∏‡¶æ‡¶á‡¶® ‡¶Ü‡¶™
                    </button>
                </form>
                <div class="mt-4 text-center">
                    <button id="toggle-auth-mode" class="text-sm text-indigo-600 hover:text-indigo-800">
                        ‡¶Ö‡¶®‡ßç‡¶Ø ‡¶Æ‡ßã‡¶°‡ßá ‡¶Ø‡¶æ‡¶®
                    </button>
                </div>
            </div>
        </div>

        <div id="custom-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-75 z-50 flex justify-center items-center">
            <div class="bg-white p-6 rounded-xl w-full max-w-sm card">
                <h3 id="modal-title" class="text-lg font-bold mb-3"></h3>
                <p id="modal-message" class="text-gray-700 mb-6"></p>
                <div id="modal-actions" class="flex justify-end space-x-3">
                    <button id="modal-cancel-button" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300 transition duration-150 hidden">‡¶¨‡¶æ‡¶§‡¶ø‡¶≤</button>
                    <button id="modal-confirm-button" class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition duration-150">‡¶†‡¶ø‡¶ï ‡¶Ü‡¶õ‡ßá</button>
                </div>
            </div>
        </div>

    </div>

    
    <script type="module">
        // ‚úÖ ‡¶´‡¶æ‡¶Ø‡¶º‡¶æ‡¶∞‡¶¨‡ßá‡¶∏ ‡¶ï‡¶®‡¶´‡¶ø‡¶ó‡¶æ‡¶∞‡ßá‡¶∂‡¶® ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá
        const firebaseConfig = {
            apiKey: "AIzaSyBcs_LrxMA_aXlZZoQ7SsLztjYU5YktEo8",
            authDomain: "readingprogressapp.firebaseapp.com",
            projectId: "readingprogressapp",
            storageBucket: "readingprogressapp.appspot.com",  // Change . firebasestorage.app to . appspot.com",
            messagingSenderId: "212134190518",
            appId: "1:212134190518:web:995a883889f375fc9e7517",
            measurementId: "G-95XJF5XGB5"
            };
            
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.6.0/firebase-app.js";
        // import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged, signInWithCustomToken, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.6.0/firebase-auth.js";
        // ‚úÖ ‡¶∂‡ßÅ‡¶ß‡ßÅ‡¶Æ‡¶æ‡¶§‡ßç‡¶∞ ‡¶™‡ßç‡¶∞‡¶Ø‡¶º‡ßã‡¶ú‡¶®‡ßÄ‡¶Ø‡¶º ‡¶Æ‡¶°‡¶ø‡¶â‡¶≤ ‡¶Ü‡¶Æ‡¶¶‡¶æ‡¶®‡¶ø ‡¶ï‡¶∞‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.6.0/firebase-auth.js";
        import { getFirestore, doc, collection, query, where, getDocs, setDoc, addDoc, onSnapshot, serverTimestamp, updateDoc, deleteDoc, runTransaction } from "https://www.gstatic.com/firebasejs/10.6.0/firebase-firestore.js";
        
        // Chart.js SDK (‡¶™‡¶∞‡¶ø‡¶∏‡¶Ç‡¶ñ‡ßç‡¶Ø‡¶æ‡¶® ‡¶¶‡ßá‡¶ñ‡¶æ‡¶®‡ßã‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø)
        import "https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js";


        
        // --- ‡¶π‡¶æ‡¶∞‡ßç‡¶°‡¶ï‡ßã‡¶°‡ßá‡¶° ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶°‡¶Æ‡¶ø‡¶® ‡¶á‡¶â‡¶ú‡¶æ‡¶∞ ‡¶Ü‡¶á‡¶°‡¶ø ---
        // ‚úÖ ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶¨‡¶æ ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶°‡¶Æ‡¶ø‡¶®‡ßá‡¶∞ ‡¶á‡¶â‡¶ú‡¶æ‡¶∞ ‡¶Ü‡¶á‡¶°‡¶ø ‡¶è‡¶ñ‡¶æ‡¶®‡ßá ‡¶∏‡ßá‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®‡•§
        const ADMIN_UID = 'XFLA7wfuLJgH7jgtRtigjbtDooM2'; 

        // Firebase ‡¶á‡¶®‡¶ø‡¶∂‡¶ø‡¶Ø‡¶º‡¶æ‡¶≤‡¶æ‡¶á‡¶ú‡ßá‡¶∂‡¶®
        let app;
        let db;
        let auth;
        let userId = null;
        let isAuthReady = false;
        let currentAuthMode = 'login'; // 'login' ‡¶¨‡¶æ 'signup'
        let timerInterval = null;
        let startTime = 0;
        let currentReadingRef = null;

        // UI ‡¶â‡¶™‡¶æ‡¶¶‡¶æ‡¶®
        const loadingSpinner = document.getElementById('loading-spinner');
        const mainUi = document.getElementById('main-ui');
        const authView = document.getElementById('auth-view');
        const authForm = document.getElementById('auth-form');
        const emailInput = document.getElementById('email');
        const passwordInput = document.getElementById('password');
        const authSubmitButton = document.getElementById('auth-submit-button');
        const authError = document.getElementById('auth-error');
        const toggleAuthModeButton = document.getElementById('toggle-auth-mode');
        const userIdDisplay = document.getElementById('user-id-display');
        const logoutButton = document.getElementById('logout-button');
        const adminTabButton = document.getElementById('admin-tab-button');

        // ‡¶°‡ßç‡¶Ø‡¶æ‡¶∂‡¶¨‡ßã‡¶∞‡ßç‡¶° ‡¶â‡¶™‡¶æ‡¶¶‡¶æ‡¶®
        const timerDisplay = document.getElementById('timer-display');
        const timerStartButton = document.getElementById('timer-start-button');
        const timerStopButton = document.getElementById('timer-stop-button');
        const timerSubjectSelect = document.getElementById('timer-subject-select');
        const subjectsView = document.getElementById('subjects-view');
        const subjectsList = document.getElementById('subjects-list');
        const subjectForm = document.getElementById('subject-form');
        const subjectNameInput = document.getElementById('subject-name-input');
        const routineList = document.getElementById('routine-list');
        const routineForm = document.getElementById('routine-form');
        const routineSubjectSelect = document.getElementById('routine-subject-select');
        const routineDurationInput = document.getElementById('routine-duration-input');
        const totalReadingTime = document.getElementById('total-reading-time');
        const dailyReadingTime = document.getElementById('daily-reading-time');
        const weeklyReadingTime = document.getElementById('weekly-reading-time');
        const goalForm = document.getElementById('goal-form');
        const dailyGoalInput = document.getElementById('daily-goal-input');
        const weeklyGoalInput = document.getElementById('weekly-goal-input');
        const planForm = document.getElementById('plan-form');
        const planSubjectSelect = document.getElementById('plan-subject-select');
        const planDaysInput = document.getElementById('plan-days-input');
        const planOutput = document.getElementById('plan-output');
        const planDetails = document.getElementById('plan-details');
        const planDailyChapters = document.getElementById('plan-daily-chapters');
        const adminUserCount = document.getElementById('admin-user-count');
        const adminTotalHours = document.getElementById('admin-total-hours');
        const adminWeeklyAvg = document.getElementById('admin-weekly-avg');
        const adminUserReportTable = document.getElementById('admin-user-report-table');

        // ‡¶ï‡¶æ‡¶∏‡ßç‡¶ü‡¶Æ ‡¶Æ‡¶°‡ßá‡¶≤
        const customModal = document.getElementById('custom-modal');
        const modalTitle = document.getElementById('modal-title');
        const modalMessage = document.getElementById('modal-message');
        const modalConfirmButton = document.getElementById('modal-confirm-button');
        const modalCancelButton = document.getElementById('modal-cancel-button');

        let weeklyChart = null; // Chart.js ‡¶á‡¶®‡¶∏‡ßç‡¶ü‡ßç‡¶Ø‡¶æ‡¶®‡ßç‡¶∏
        
        // ‡¶∏‡¶Æ‡¶∏‡ßç‡¶§ ‡¶¨‡¶ø‡¶∑‡¶Ø‡¶º‡¶¨‡¶∏‡ßç‡¶§‡ßÅ ‡¶∏‡¶Ç‡¶∞‡¶ï‡ßç‡¶∑‡¶£ ‡¶ï‡¶∞‡¶æ‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶ó‡ßç‡¶≤‡ßã‡¶¨‡¶æ‡¶≤ ‡¶≠‡ßá‡¶∞‡¶ø‡¶Ø‡¶º‡ßá‡¶¨‡¶≤
        let allSubjects = [];
        let allReadingSessions = [];

        // --- ‡¶∏‡¶æ‡¶π‡¶æ‡¶Ø‡ßç‡¶Ø‡¶ï‡¶æ‡¶∞‡ßÄ ‡¶´‡¶æ‡¶Ç‡¶∂‡¶®: ‡¶Æ‡¶°‡ßá‡¶≤ UI ---

        /** ‡¶è‡¶ï‡¶ü‡¶ø ‡¶ï‡¶æ‡¶∏‡ßç‡¶ü‡¶Æ ‡¶Æ‡¶°‡ßá‡¶≤/‡¶°‡¶æ‡¶Ø‡¶º‡¶æ‡¶≤‡¶ó ‡¶¶‡ßá‡¶ñ‡¶æ‡¶Ø‡¶º */
        function showModal(title, message, isConfirm, onConfirm) {
            modalTitle.textContent = title;
            modalMessage.textContent = message;
            
            modalConfirmButton.textContent = isConfirm ? '‡¶®‡¶ø‡¶∂‡ßç‡¶ö‡¶ø‡¶§ ‡¶ï‡¶∞‡ßÅ‡¶®' : '‡¶†‡¶ø‡¶ï ‡¶Ü‡¶õ‡ßá';
            modalCancelButton.classList.toggle('hidden', !isConfirm);

            customModal.classList.remove('hidden');

            // ‡¶®‡¶ø‡¶∂‡ßç‡¶ö‡¶ø‡¶§ ‡¶¨‡¶æ OK ‡¶¨‡¶æ‡¶ü‡¶®‡ßá ‡¶ï‡ßç‡¶≤‡¶ø‡¶ï ‡¶π‡ßç‡¶Ø‡¶æ‡¶®‡ßç‡¶°‡¶≤‡¶æ‡¶∞
            modalConfirmButton.onclick = () => {
                customModal.classList.add('hidden');
                if (onConfirm) onConfirm();
            };

            // ‡¶¨‡¶æ‡¶§‡¶ø‡¶≤ ‡¶¨‡¶æ‡¶ü‡¶®‡ßá ‡¶ï‡ßç‡¶≤‡¶ø‡¶ï ‡¶π‡ßç‡¶Ø‡¶æ‡¶®‡ßç‡¶°‡¶≤‡¶æ‡¶∞
            modalCancelButton.onclick = () => {
                customModal.classList.add('hidden');
            };
        }

        /** ‡¶Æ‡¶ø‡¶®‡¶ø‡¶ü‡¶ï‡ßá HH:MM:SS ‡¶´‡¶∞‡¶Æ‡ßç‡¶Ø‡¶æ‡¶ü‡ßá ‡¶∞‡ßÇ‡¶™‡¶æ‡¶®‡ßç‡¶§‡¶∞ ‡¶ï‡¶∞‡ßá */
        function formatSeconds(seconds) {
            const h = String(Math.floor(seconds / 3600)).padStart(2, '0');
            const m = String(Math.floor((seconds % 3600) / 60)).padStart(2, '0');
            const s = String(seconds % 60).padStart(2, '0');
            return `${h}:${m}:${s}`;
        }
        
        /** HH:MM:SS ‡¶´‡¶∞‡¶Æ‡ßç‡¶Ø‡¶æ‡¶ü‡¶ï‡ßá ‡¶ò‡¶£‡ßç‡¶ü‡¶æ‡¶Ø‡¶º ‡¶∞‡ßÇ‡¶™‡¶æ‡¶®‡ßç‡¶§‡¶∞ ‡¶ï‡¶∞‡ßá */
        function secondsToHours(seconds) {
            return (seconds / 3600).toFixed(2);
        }

        // --- Firebase ‡¶á‡¶®‡¶ø‡¶∂‡¶ø‡¶Ø‡¶º‡¶æ‡¶≤‡¶æ‡¶á‡¶ú‡ßá‡¶∂‡¶® ‡¶ì ‡¶Ö‡¶•‡ßá‡¶®‡ßç‡¶ü‡¶ø‡¶ï‡ßá‡¶∂‡¶® ---

        async function initFirebase() {
            try {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                
                // ‚úÖ `signInAnonymously(auth)` ‡¶∏‡¶∞‡¶æ‡¶®‡ßã ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá
                // Auth State Observer
                onAuthStateChanged(auth, (user) => {
                    loadingSpinner.classList.add('hidden');
                    isAuthReady = true;

                    if (user) {
                        userId = user.uid;
                        userIdDisplay.textContent = `‡¶á‡¶â‡¶ú‡¶æ‡¶∞ ‡¶Ü‡¶á‡¶°‡¶ø: ${userId}`;
                        userIdDisplay.classList.remove('hidden');
                        authView.classList.add('hidden');
                        mainUi.classList.remove('hidden');
                        
                        // ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶°‡¶Æ‡¶ø‡¶® ‡¶™‡ßç‡¶Ø‡¶æ‡¶®‡ßá‡¶≤ ‡¶¶‡ßá‡¶ñ‡¶æ‡¶®‡ßã
                        if (userId === ADMIN_UID) {
                            adminTabButton.classList.remove('hidden');
                            loadAdminData();
                        } else {
                            adminTabButton.classList.add('hidden');
                        }
                        
                        // ‡¶á‡¶â‡¶ú‡¶æ‡¶∞ ‡¶°‡ßá‡¶ü‡¶æ ‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡¶æ
                        loadUserData();

                    } else {
                        // ‡¶≤‡¶ó‡¶Ü‡¶â‡¶ü ‡¶π‡¶≤‡ßá ‡¶¨‡¶æ ‡¶∏‡ßá‡¶∂‡¶® ‡¶®‡¶æ ‡¶•‡¶æ‡¶ï‡¶≤‡ßá
                        userId = null;
                        mainUi.classList.add('hidden');
                        authView.classList.remove('hidden');
                        document.querySelectorAll('.view-content').forEach(el => el.classList.add('hidden'));
                    }
                });
            } catch (error) {
                console.error("Firebase ‡¶á‡¶®‡¶ø‡¶∂‡¶ø‡¶Ø‡¶º‡¶æ‡¶≤‡¶æ‡¶á‡¶ú‡ßá‡¶∂‡¶®‡ßá ‡¶§‡ßç‡¶∞‡ßÅ‡¶ü‡¶ø:", error);
                loadingSpinner.innerHTML = `<p class="text-red-600">‡¶§‡ßç‡¶∞‡ßÅ‡¶ü‡¶ø: Firebase ‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡¶æ ‡¶Ø‡¶æ‡¶Ø‡¶º‡¶®‡¶ø‡•§ ‡¶ï‡¶®‡¶∏‡ßã‡¶≤ ‡¶¶‡ßá‡¶ñ‡ßÅ‡¶®‡•§</p>`;
            }
        }

        // --- ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶°‡¶Æ‡¶ø‡¶® ‡¶°‡ßá‡¶ü‡¶æ ‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡¶æ (‡¶∏‡¶ï‡¶≤ ‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞‡¶ï‡¶æ‡¶∞‡ßÄ‡¶∞ ‡¶™‡¶∞‡¶ø‡¶∏‡¶Ç‡¶ñ‡ßç‡¶Ø‡¶æ‡¶®) ---

async function loadAdminData() {
    try {
        // ‡ßß. ‡¶∏‡¶ï‡¶≤ ‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞‡¶ï‡¶æ‡¶∞‡ßÄ ‡¶∏‡¶Ç‡¶ñ‡ßç‡¶Ø‡¶æ ‡¶¨‡ßá‡¶∞ ‡¶ï‡¶∞‡¶æ
        const usersSnapshot = await getDocs(collection(db, 'users'));
        const allUsers = usersSnapshot.docs. map(d => d.id).filter(uid => uid !== ADMIN_UID);
        
        // Admin user count ‡¶è ‡¶¶‡ßá‡¶ñ‡¶æ‡¶®‡ßã
        adminUserCount. textContent = allUsers.length;

        // ‡ß®. ‡¶∏‡¶ï‡¶≤ ‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞‡¶ï‡¶æ‡¶∞‡ßÄ‡¶∞ ‡¶Æ‡ßã‡¶ü ‡¶™‡¶°‡¶º‡¶æ‡¶∞ ‡¶∏‡¶Æ‡¶Ø‡¶º ‡¶è‡¶¨‡¶Ç ‡¶∞‡¶ø‡¶™‡ßã‡¶∞‡ßç‡¶ü
        let totalHours = 0;
        let lastActivityDates = [];
        const userReportData = [];

        for (const uId of allUsers) {
            try {
                // ‡¶™‡ßç‡¶∞‡¶§‡¶ø‡¶ü‡¶ø ‡¶á‡¶â‡¶ú‡¶æ‡¶∞‡ßá‡¶∞ reading_sessions ‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡¶æ
                const sessionsQuery = query(
                    collection(db, `users/${uId}/reading_sessions`)
                );
                const sessionsSnapshot = await getDocs(sessionsQuery);
                
                let userTotalSeconds = 0;
                let userLastActivity = new Date(0); // ‡¶∏‡¶¨‡¶ö‡ßá‡¶Ø‡¶º‡ßá ‡¶™‡ßÅ‡¶∞‡¶æ‡¶®‡ßã ‡¶∏‡¶Æ‡¶Ø‡¶º

                sessionsSnapshot.docs.forEach(doc => {
                    const session = doc.data();
                    userTotalSeconds += session. durationSeconds || 0;
                    
                    if (session.startTime && session.startTime. toDate) {
                        const sessionDate = session.startTime.toDate();
                        if (sessionDate > userLastActivity) {
                            userLastActivity = sessionDate;
                        }
                    }
                });

                totalHours += userTotalSeconds / 3600; // ‡¶∏‡ßá‡¶ï‡ßá‡¶®‡ßç‡¶° ‡¶•‡ßá‡¶ï‡ßá ‡¶ò‡¶£‡ßç‡¶ü‡¶æ‡¶Ø‡¶º ‡¶∞‡ßÇ‡¶™‡¶æ‡¶®‡ßç‡¶§‡¶∞
                
                // ‡¶á‡¶â‡¶ú‡¶æ‡¶∞ ‡¶∞‡¶ø‡¶™‡ßã‡¶∞‡ßç‡¶ü ‡¶°‡ßá‡¶ü‡¶æ ‡¶∏‡¶Ç‡¶∞‡¶ï‡ßç‡¶∑‡¶£
                userReportData.push({
                    userId: uId,
                    totalHours: (userTotalSeconds / 3600). toFixed(2),
                    lastActivity: userLastActivity.toDateString()
                });

                lastActivityDates.push(userLastActivity);

            } catch (error) {
                console.error(`Error loading sessions for user ${uId}:`, error);
            }
        }

        // ‡ß©. ‡¶Æ‡ßã‡¶ü ‡¶™‡¶°‡¶º‡¶æ‡¶∞ ‡¶∏‡¶Æ‡¶Ø‡¶º ‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶ï‡¶∞‡¶æ
        adminTotalHours.textContent = totalHours. toFixed(2);

        // ‡ß™. ‡¶∏‡¶æ‡¶™‡ßç‡¶§‡¶æ‡¶π‡¶ø‡¶ï ‡¶ó‡¶°‡¶º ‡¶¨‡ßá‡¶∞ ‡¶ï‡¶∞‡¶æ
        const now = new Date();
        const startOfWeek = getStartOfWeek(now);
        let weeklyTotalSeconds = 0;

        for (const uId of allUsers) {
            const sessionsQuery = query(
                collection(db, `users/${uId}/reading_sessions`)
            );
            const sessionsSnapshot = await getDocs(sessionsQuery);

            sessionsSnapshot.docs.forEach(doc => {
                const session = doc.data();
                if (session.startTime && session. startTime.toDate) {
                    const sessionDate = session. startTime.toDate();
                    if (sessionDate >= startOfWeek) {
                        weeklyTotalSeconds += session.durationSeconds || 0;
                    }
                }
            });
        }

        const weeklyAverage = allUsers.length > 0 
            ? (weeklyTotalSeconds / 3600 / allUsers.length).toFixed(2) 
            : 0;
        adminWeeklyAvg.textContent = weeklyAverage;

        // ‡ß´. ‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞‡¶ï‡¶æ‡¶∞‡ßÄ ‡¶ï‡¶æ‡¶∞‡ßç‡¶Ø‡¶ï‡¶≤‡¶æ‡¶™ ‡¶ü‡ßá‡¶¨‡¶ø‡¶≤ ‡¶∞‡ßá‡¶®‡ßç‡¶°‡¶æ‡¶∞ ‡¶ï‡¶∞‡¶æ
        adminUserReportTable.innerHTML = '';
        
        if (userReportData.length === 0) {
            adminUserReportTable.innerHTML = `
                <tr>
                    <td colspan="3" class="px-6 py-4 text-center text-gray-500">‡¶ï‡ßã‡¶®‡ßã ‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞‡¶ï‡¶æ‡¶∞‡ßÄ ‡¶°‡ßá‡¶ü‡¶æ ‡¶™‡¶æ‡¶ì‡¶Ø‡¶º‡¶æ ‡¶Ø‡¶æ‡¶Ø‡¶º‡¶®‡¶ø</td>
                </tr>
            `;
            return;
        }

        // ‡¶ü‡ßá‡¶¨‡¶ø‡¶≤ ‡¶∞‡ßã ‡¶§‡ßà‡¶∞‡¶ø
        userReportData.forEach(user => {
            const row = `
                <tr class="hover:bg-gray-50">
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 font-mono">${user.userId. substring(0, 10)}...</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${user.totalHours} ‡¶ò‡¶£‡ßç‡¶ü‡¶æ</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">${user.lastActivity}</td>
                </tr>
            `;
            adminUserReportTable.insertAdjacentHTML('beforeend', row);
        });

    } catch (error) {
        console.error("Error loading admin data:", error);
        showModal('‡¶§‡ßç‡¶∞‡ßÅ‡¶ü‡¶ø', '‡¶Ö‡ßç‡¶Ø‡¶æ‡¶°‡¶Æ‡¶ø‡¶® ‡¶°‡ßá‡¶ü‡¶æ ‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡¶æ ‡¶Ø‡¶æ‡¶Ø‡¶º‡¶®‡¶ø‡•§', false);
    }
}


        
        // ‡¶≤‡¶ó‡¶á‡¶®/‡¶∏‡¶æ‡¶á‡¶®‡¶Ü‡¶™ ‡¶ü‡¶ó‡¶≤
        toggleAuthModeButton.addEventListener('click', () => {
            currentAuthMode = currentAuthMode === 'login' ? 'signup' : 'login';
            authSubmitButton.textContent = currentAuthMode === 'login' ? '‡¶≤‡¶ó‡¶á‡¶®' : '‡¶∏‡¶æ‡¶á‡¶® ‡¶Ü‡¶™';
            toggleAuthModeButton.textContent = currentAuthMode === 'login' ? '‡¶Ö‡ßç‡¶Ø‡¶æ‡¶ï‡¶æ‡¶â‡¶®‡ßç‡¶ü ‡¶®‡ßá‡¶á? ‡¶∏‡¶æ‡¶á‡¶® ‡¶Ü‡¶™ ‡¶ï‡¶∞‡ßÅ‡¶®' : '‡¶á‡¶§‡¶ø‡¶Æ‡¶ß‡ßç‡¶Ø‡ßá ‡¶è‡¶ï‡¶ü‡¶ø ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶ï‡¶æ‡¶â‡¶®‡ßç‡¶ü ‡¶Ü‡¶õ‡ßá? ‡¶≤‡¶ó‡¶á‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®';
            authError.textContent = '';
        });

        // ‡¶Ö‡¶•‡ßá‡¶®‡ßç‡¶ü‡¶ø‡¶ï‡ßá‡¶∂‡¶® ‡¶´‡¶∞‡ßç‡¶Æ ‡¶ú‡¶Æ‡¶æ ‡¶¶‡ßá‡¶ì‡ßü‡¶æ
        authForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            authError.textContent = '';
            const email = emailInput.value;
            const password = passwordInput.value;
            
            try {
                if (currentAuthMode === 'signup') {
                    await createUserWithEmailAndPassword(auth, email, password);
                } else {
                    await signInWithEmailAndPassword(auth, email, password);
                }
            } catch (error) {
                console.error("Authentication Error:", error);
                authError.textContent = `‡¶§‡ßç‡¶∞‡ßÅ‡¶ü‡¶ø: ${error.message.includes('auth/invalid-credential') ? '‡¶≠‡ßÅ‡¶≤ ‡¶á‡¶Æ‡ßá‡¶á‡¶≤ ‡¶¨‡¶æ ‡¶™‡¶æ‡¶∏‡¶ì‡¶Ø‡¶º‡¶æ‡¶∞‡ßç‡¶°' : error.message}`;
            }
        });

        // ‡¶≤‡¶ó‡¶Ü‡¶â‡¶ü
        logoutButton.addEventListener('click', async () => {
            try {
                // ‡¶ü‡¶æ‡¶á‡¶Æ‡¶æ‡¶∞ ‡¶ö‡¶≤‡¶≤‡ßá ‡¶∏‡ßá‡¶≠ ‡¶ï‡¶∞‡ßá ‡¶¨‡¶®‡ßç‡¶ß ‡¶ï‡¶∞‡¶æ
                if (timerInterval) await stopTimer(); 
                await signOut(auth);
                showModal('‡¶∏‡¶´‡¶≤', '‡¶Ü‡¶™‡¶®‡¶ø ‡¶∏‡¶´‡¶≤‡¶≠‡¶æ‡¶¨‡ßá ‡¶≤‡¶ó‡¶Ü‡¶â‡¶ü ‡¶ï‡¶∞‡ßá‡¶õ‡ßá‡¶®‡•§', false);
            } catch (error) {
                showModal('‡¶§‡ßç‡¶∞‡ßÅ‡¶ü‡¶ø', '‡¶≤‡¶ó‡¶Ü‡¶â‡¶ü ‡¶ï‡¶∞‡¶æ ‡¶∏‡¶Æ‡ßç‡¶≠‡¶¨ ‡¶π‡¶Ø‡¶º‡¶®‡¶ø‡•§', false);
            }
        });
        

type ReadingGoal @table {
  user: User!
  goalType: String!
  targetValue: Int!
  period: String!
  startDate: Timestamp!
  endDate: Timestamp
  description: String
}
        // --- ‡¶°‡ßá‡¶ü‡¶æ‡¶¨‡ßá‡¶∏ ‡¶™‡¶æ‡¶• ‡¶´‡¶æ‡¶Ç‡¶∂‡¶® ---
        // ‚úÖ ‡¶´‡¶æ‡¶Ø‡¶º‡¶æ‡¶∞‡¶∏‡ßç‡¶ü‡ßã‡¶∞ ‡¶™‡¶æ‡¶•‡¶ó‡ßÅ‡¶≤‡¶ø ‡¶∏‡¶π‡¶ú ‡¶è‡¶¨‡¶Ç ‡¶∏‡ßç‡¶ü‡ßç‡¶Ø‡¶æ‡¶®‡ßç‡¶°‡¶æ‡¶∞‡ßç‡¶° ‡¶ï‡¶∞‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá (appId ‡¶∏‡¶∞‡¶æ‡¶®‡ßã ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá)
        const getUserCollectionRef = (collectionName) => collection(db, `users/${userId}/${collectionName}`);
        const getAdminCollectionRef = (collectionName) => collection(db, `public_data/${collectionName}`);

        // --- ‡¶∞‡¶ø‡¶Ø‡¶º‡ßá‡¶≤-‡¶ü‡¶æ‡¶á‡¶Æ ‡¶°‡ßá‡¶ü‡¶æ ‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡¶æ (onSnapshot) ---

        function loadUserData() {
            if (!userId) return;

            // ‡ßß. ‡¶¨‡¶ø‡¶∑‡¶Ø‡¶º ‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡¶æ
            onSnapshot(getUserCollectionRef('subjects'), (snapshot) => {
                allSubjects = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderSubjectDropdowns();
                renderSubjectsList();
            }, (error) => console.error("Subjects Snapshot Error:", error));
            
            // ‡ß®. ‡¶∞‡¶ø‡¶°‡¶ø‡¶Ç ‡¶∏‡ßá‡¶∂‡¶® ‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡¶æ
            onSnapshot(getUserCollectionRef('reading_sessions'), (snapshot) => {
                allReadingSessions = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                calculateAndRenderStats();
            }, (error) => console.error("Sessions Snapshot Error:", error));

            // ‡ß©. ‡¶∞‡ßÅ‡¶ü‡¶ø‡¶® ‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡¶æ
            onSnapshot(getUserCollectionRef('routines'), (snapshot) => {
                const routines = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderRoutineList(routines);
            }, (error) => console.error("Routines Snapshot Error:", error));
            
            // ‡ß™. ‡¶≤‡¶ï‡ßç‡¶∑‡ßç‡¶Ø ‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡¶æ
            onSnapshot(doc(db, `users/${userId}/settings/goals`), (docSnapshot) => { // ‚úÖ ‡¶™‡¶æ‡¶• ‡¶†‡¶ø‡¶ï ‡¶ï‡¶∞‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá
                if (docSnapshot.exists()) {
                    const goals = docSnapshot.data();
                    dailyGoalInput.value = goals.dailyGoal || '';
                    weeklyGoalInput.value = goals.weeklyGoal || '';
                }
            }, (error) => console.error("Goals Snapshot Error:", error));

            function loadUserData() {
    if (! userId) return;

    // ‡¶¨‡¶ø‡¶¶‡ßç‡¶Ø‡¶Æ‡¶æ‡¶® ‡¶ï‡ßã‡¶°... 

    // ‚úÖ Phase 1 ‡¶´‡¶ø‡¶ö‡¶æ‡¶∞ ‡¶Ø‡ßÅ‡¶ï‡ßç‡¶§ ‡¶ï‡¶∞‡ßÅ‡¶®:
    onSnapshot(getUserCollectionRef('reading_sessions'), (snapshot) => {
        allReadingSessions = snapshot.docs.map(doc => ({ id: doc.id, ... doc.data() }));
        calculateAndRenderStats();
        
        // ‚úÖ ‡¶®‡¶§‡ßÅ‡¶® ‡¶´‡¶ø‡¶ö‡¶æ‡¶∞:
        calculateStreak();
        updateCalendarData();
        populateHistorySubjectFilter();
        filterAndRenderHistory();
    }, (error) => console.error("Sessions Snapshot Error:", error));
        }
        }
        
        // --- ‡¶¨‡¶ø‡¶∑‡¶Ø‡¶º ‡¶ì ‡¶Ö‡¶ß‡ßç‡¶Ø‡¶æ‡¶Ø‡¶º ‡¶Æ‡ßç‡¶Ø‡¶æ‡¶®‡ßá‡¶ú‡¶Æ‡ßá‡¶®‡ßç‡¶ü (‡ßß. ‡¶ì ‡ß©. ‡¶è‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø) ---

        // ‡¶°‡ßç‡¶∞‡¶™‡¶°‡¶æ‡¶â‡¶® ‡¶∞‡ßá‡¶®‡ßç‡¶°‡¶æ‡¶∞ ‡¶ï‡¶∞‡¶æ (‡¶ü‡¶æ‡¶á‡¶Æ‡¶æ‡¶∞ ‡¶ì ‡¶∞‡ßÅ‡¶ü‡¶ø‡¶®‡ßá‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø)
        function renderSubjectDropdowns() {
            timerSubjectSelect.innerHTML = '<option value="" disabled selected>‡¶¨‡¶ø‡¶∑‡ßü/‡¶Ö‡¶ß‡ßç‡¶Ø‡¶æ‡ßü ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®</option>';
            routineSubjectSelect.innerHTML = '<option value="" disabled selected>‡¶¨‡¶ø‡¶∑‡ßü ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®</option>';
            planSubjectSelect.innerHTML = '<option value="" disabled selected>‡¶™‡¶∞‡¶ø‡¶ï‡¶≤‡ßç‡¶™‡¶®‡¶æ‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶¨‡¶ø‡¶∑‡¶Ø‡¶º ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®</option>';

            allSubjects.forEach(subject => {
                // ‡¶¨‡¶ø‡¶∑‡¶Ø‡¶º ‡¶π‡¶ø‡¶∏‡¶æ‡¶¨‡ßá ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡¶æ
                const option = `<option value="${subject.id}">${subject.name}</option>`;
                timerSubjectSelect.insertAdjacentHTML('beforeend', option);
                routineSubjectSelect.insertAdjacentHTML('beforeend', option);
                planSubjectSelect.insertAdjacentHTML('beforeend', option);

                // ‡¶Ö‡¶ß‡ßç‡¶Ø‡¶æ‡¶Ø‡¶º ‡¶π‡¶ø‡¶∏‡¶æ‡¶¨‡ßá ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡¶æ
                if (subject.chapters && Array.isArray(subject.chapters)) {
                    subject.chapters.forEach((chapter, index) => {
                        timerSubjectSelect.insertAdjacentHTML('beforeend', 
                            `<option value="${subject.id}_${index}">${subject.name} > ${chapter}</option>`
                        );
                    });
                }
            });
        }
        
        // ‡¶¨‡¶ø‡¶∑‡¶Ø‡¶º ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡¶æ
        subjectForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const name = subjectNameInput.value.trim();
            if (!name) return;

            try {
                await addDoc(getUserCollectionRef('subjects'), {
                    name: name,
                    chapters: [],
                    createdAt: serverTimestamp()
                });
                subjectNameInput.value = '';
                showModal('‡¶∏‡¶´‡¶≤', `${name} ‡¶∏‡¶´‡¶≤‡¶≠‡¶æ‡¶¨‡ßá ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá‡•§`, false);
            } catch (error) {
                console.error("Error adding subject:", error);
                showModal('‡¶§‡ßç‡¶∞‡ßÅ‡¶ü‡¶ø', '‡¶¨‡¶ø‡¶∑‡¶Ø‡¶º ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡¶æ ‡¶Ø‡¶æ‡¶Ø‡¶º‡¶®‡¶ø‡•§', false);
            }
        });

        // ‡¶¨‡¶ø‡¶∑‡¶Ø‡¶º ‡¶§‡¶æ‡¶≤‡¶ø‡¶ï‡¶æ ‡¶∞‡ßá‡¶®‡ßç‡¶°‡¶æ‡¶∞ ‡¶ï‡¶∞‡¶æ
        function renderSubjectsList() {
            subjectsList.innerHTML = '';
            if (allSubjects.length === 0) {
                subjectsList.innerHTML = '<p class="text-gray-500">‡¶è‡¶ñ‡¶®‡ßã ‡¶ï‡ßã‡¶®‡ßã ‡¶¨‡¶ø‡¶∑‡¶Ø‡¶º ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡¶æ ‡¶π‡¶Ø‡¶º‡¶®‡¶ø‡•§</p>';
                return;
            }

            allSubjects.forEach(subject => {
                const chapterCount = subject.chapters ? subject.chapters.length : 0;
                
                const subjectHtml = `
                    <div class="p-4 bg-gray-50 rounded-lg border border-gray-200">
                        <div class="flex justify-between items-center">
                            <h3 class="text-lg font-medium text-gray-800">${subject.name} <span class="text-sm text-gray-500">(${chapterCount} ‡¶Ö‡¶ß‡ßç‡¶Ø‡¶æ‡¶Ø‡¶º)</span></h3>
                            <button data-subject-id="${subject.id}" class="delete-subject-btn text-red-500 hover:text-red-700 transition duration-150">
                                <i data-lucide="trash-2" class="w-4 h-4"></i>
                            </button>
                        </div>
                        <div class="mt-3">
                            <form class="add-chapter-form flex space-x-2" data-subject-id="${subject.id}">
                                <input type="text" placeholder="‡¶®‡¶§‡ßÅ‡¶® ‡¶Ö‡¶ß‡ßç‡¶Ø‡¶æ‡¶Ø‡¶º‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ" class="flex-1 p-2 border border-gray-300 rounded-lg text-sm">
                                <button type="submit" class="bg-indigo-500 text-white text-sm px-3 py-2 rounded-lg hover:bg-indigo-600">‡¶Ö‡¶ß‡ßç‡¶Ø‡¶æ‡¶Ø‡¶º ‡¶Ø‡ßã‡¶ó</button>
                            </form>
                            <ul class="mt-3 space-y-1 text-sm text-gray-600 list-disc list-inside">
                                ${subject.chapters && subject.chapters.map((chap, idx) => 
                                    `<li>${chap} 
                                        <button data-subject-id="${subject.id}" data-chapter-index="${idx}" class="delete-chapter-btn text-red-400 hover:text-red-600 ml-2">
                                            <i data-lucide="x" class="w-3 h-3 inline-block"></i>
                                        </button>
                                    </li>`
                                ).join('') || ''}
                            </ul>
                        </div>
                    </div>
                `;
                subjectsList.insertAdjacentHTML('beforeend', subjectHtml);
            });
            // Lucide ‡¶Ü‡¶á‡¶ï‡¶® ‡¶∞‡ßá‡¶®‡ßç‡¶°‡¶æ‡¶∞ ‡¶ï‡¶∞‡¶æ
            lucide.createIcons();
        }

        // ‡¶Ö‡¶ß‡ßç‡¶Ø‡¶æ‡¶Ø‡¶º ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡¶æ
        subjectsList.addEventListener('submit', async (e) => {
            if (e.target.classList.contains('add-chapter-form')) {
                e.preventDefault();
                const subjectId = e.target.dataset.subjectId;
                const chapterInput = e.target.querySelector('input');
                const chapterName = chapterInput.value.trim();

                if (!chapterName) return;

                const subjectDocRef = doc(getUserCollectionRef('subjects'), subjectId);
                const currentSubject = allSubjects.find(s => s.id === subjectId);
                
                if (currentSubject) {
                    const updatedChapters = [...(currentSubject.chapters || []), chapterName];
                    try {
                        await updateDoc(subjectDocRef, { chapters: updatedChapters });
                        chapterInput.value = '';
                        showModal('‡¶∏‡¶´‡¶≤', `‡¶Ö‡¶ß‡ßç‡¶Ø‡¶æ‡¶Ø‡¶º‡¶ü‡¶ø ‡¶∏‡¶´‡¶≤‡¶≠‡¶æ‡¶¨‡ßá ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá‡•§`, false);
                    } catch (error) {
                        console.error("Error adding chapter:", error);
                        showModal('‡¶§‡ßç‡¶∞‡ßÅ‡¶ü‡¶ø', '‡¶Ö‡¶ß‡ßç‡¶Ø‡¶æ‡¶Ø‡¶º ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡¶æ ‡¶Ø‡¶æ‡¶Ø‡¶º‡¶®‡¶ø‡•§', false);
                    }
                }
            }
        });
        
        // ‡¶Ö‡¶ß‡ßç‡¶Ø‡¶æ‡¶Ø‡¶º ‡¶Æ‡ßÅ‡¶õ‡ßá ‡¶´‡ßá‡¶≤‡¶æ
        subjectsList.addEventListener('click', async (e) => {
            if (e.target.closest('.delete-chapter-btn')) {
                const btn = e.target.closest('.delete-chapter-btn');
                const subjectId = btn.dataset.subjectId;
                const chapterIndex = parseInt(btn.dataset.chapterIndex);
                
                showModal('‡¶Æ‡ßÅ‡¶õ‡ßá ‡¶´‡ßá‡¶≤‡¶æ ‡¶π‡¶¨‡ßá?', '‡¶Ü‡¶™‡¶®‡¶ø ‡¶ï‡¶ø ‡¶®‡¶ø‡¶∂‡ßç‡¶ö‡¶ø‡¶§ ‡¶è‡¶á ‡¶Ö‡¶ß‡ßç‡¶Ø‡¶æ‡¶Ø‡¶º‡¶ü‡¶ø ‡¶Æ‡ßÅ‡¶õ‡ßá ‡¶´‡ßá‡¶≤‡¶§‡ßá ‡¶ö‡¶æ‡¶®?', true, async () => {
                    const subjectDocRef = doc(getUserCollectionRef('subjects'), subjectId);
                    const currentSubject = allSubjects.find(s => s.id === subjectId);
                    
                    if (currentSubject && currentSubject.chapters) {
                        const updatedChapters = currentSubject.chapters.filter((_, index) => index !== chapterIndex);
                        try {
                            await updateDoc(subjectDocRef, { chapters: updatedChapters });
                            showModal('‡¶∏‡¶´‡¶≤', '‡¶Ö‡¶ß‡ßç‡¶Ø‡¶æ‡¶Ø‡¶º ‡¶Æ‡ßÅ‡¶õ‡ßá ‡¶´‡ßá‡¶≤‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá‡•§', false);
                        } catch (error) {
                            console.error("Error deleting chapter:", error);
                            showModal('‡¶§‡ßç‡¶∞‡ßÅ‡¶ü‡¶ø', '‡¶Ö‡¶ß‡ßç‡¶Ø‡¶æ‡¶Ø‡¶º ‡¶Æ‡ßÅ‡¶õ‡ßá ‡¶´‡ßá‡¶≤‡¶æ ‡¶Ø‡¶æ‡¶Ø‡¶º‡¶®‡¶ø‡•§', false);
                        }
                    }
                });
            }
            
            // ‡¶¨‡¶ø‡¶∑‡¶Ø‡¶º ‡¶Æ‡ßÅ‡¶õ‡ßá ‡¶´‡ßá‡¶≤‡¶æ
            if (e.target.closest('.delete-subject-btn')) {
                const btn = e.target.closest('.delete-subject-btn');
                const subjectId = btn.dataset.subjectId;
                
                showModal('‡¶Æ‡ßÅ‡¶õ‡ßá ‡¶´‡ßá‡¶≤‡¶æ ‡¶π‡¶¨‡ßá?', '‡¶è‡¶á ‡¶¨‡¶ø‡¶∑‡¶Ø‡¶º ‡¶è‡¶¨‡¶Ç ‡¶è‡¶∞ ‡¶∏‡¶Æ‡¶∏‡ßç‡¶§ ‡¶Ö‡¶ß‡ßç‡¶Ø‡¶æ‡¶Ø‡¶º ‡¶Æ‡ßÅ‡¶õ‡ßá ‡¶´‡ßá‡¶≤‡¶æ ‡¶π‡¶¨‡ßá‡•§ ‡¶Ü‡¶™‡¶®‡¶ø ‡¶ï‡¶ø ‡¶®‡¶ø‡¶∂‡ßç‡¶ö‡¶ø‡¶§?', true, async () => {
                    try {
                        await deleteDoc(doc(getUserCollectionRef('subjects'), subjectId));
                        showModal('‡¶∏‡¶´‡¶≤', '‡¶¨‡¶ø‡¶∑‡¶Ø‡¶º‡¶ü‡¶ø ‡¶Æ‡ßÅ‡¶õ‡ßá ‡¶´‡ßá‡¶≤‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá‡•§', false);
                    } catch (error) {
                        console.error("Error deleting subject:", error);
                        showModal('‡¶§‡ßç‡¶∞‡ßÅ‡¶ü‡¶ø', '‡¶¨‡¶ø‡¶∑‡¶Ø‡¶º‡¶ü‡¶ø ‡¶Æ‡ßÅ‡¶õ‡ßá ‡¶´‡ßá‡¶≤‡¶æ ‡¶Ø‡¶æ‡¶Ø‡¶º‡¶®‡¶ø‡•§', false);
                    }
                });
            }
        });


        // --- ‡¶∞‡¶ø‡¶°‡¶ø‡¶Ç ‡¶ü‡¶æ‡¶á‡¶Æ‡¶æ‡¶∞ ‡¶≤‡¶ú‡¶ø‡¶ï (‡ß©. ‡¶ï‡¶æ‡¶∏‡ßç‡¶ü‡¶Æ ‡¶ü‡¶æ‡¶á‡¶Æ‡¶æ‡¶∞) ---

        function updateTimerDisplay() {
            const elapsedTime = Math.floor((Date.now() - startTime) / 1000);
            timerDisplay.textContent = formatSeconds(elapsedTime);
        }

        async function startTimer() {
            const subjectChapter = timerSubjectSelect.value;
            if (!subjectChapter) {
                showModal('‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®', '‡¶ü‡¶æ‡¶á‡¶Æ‡¶æ‡¶∞ ‡¶∂‡ßÅ‡¶∞‡ßÅ ‡¶ï‡¶∞‡¶æ‡¶∞ ‡¶Ü‡¶ó‡ßá ‡¶è‡¶ï‡¶ü‡¶ø ‡¶¨‡¶ø‡¶∑‡¶Ø‡¶º ‡¶¨‡¶æ ‡¶Ö‡¶ß‡ßç‡¶Ø‡¶æ‡¶Ø‡¶º ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®‡•§', false);
                return;
            }
            
            // ‡¶ü‡¶æ‡¶á‡¶Æ‡¶æ‡¶∞ ‡¶∏‡ßá‡¶≠ ‡¶ï‡¶∞‡¶æ‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶è‡¶ï‡¶ü‡¶ø ‡¶®‡¶§‡ßÅ‡¶® ‡¶°‡¶ï‡ßÅ‡¶Æ‡ßá‡¶®‡ßç‡¶ü ‡¶§‡ßà‡¶∞‡¶ø ‡¶ï‡¶∞‡¶æ
            currentReadingRef = doc(getUserCollectionRef('reading_sessions'), crypto.randomUUID());
            await setDoc(currentReadingRef, {
                subjectChapter: subjectChapter,
                startTime: serverTimestamp(),
                durationSeconds: 0,
                status: 'running'
            });

            startTime = Date.now();
            timerInterval = setInterval(updateTimerDisplay, 1000);
            
            timerStartButton.disabled = true;
            timerStopButton.disabled = false;
            timerStartButton.textContent = '‡¶ö‡¶≤‡¶õ‡ßá...';
            timerStartButton.classList.remove('bg-indigo-600', 'hover:bg-indigo-700');
            timerStartButton.classList.add('bg-gray-400');
            timerSubjectSelect.disabled = true;
        }

        async function stopTimer() {
            if (!timerInterval) return;

            clearInterval(timerInterval);
            const durationSeconds = Math.floor((Date.now() - startTime) / 1000);

            if (currentReadingRef) {
                try {
                    await updateDoc(currentReadingRef, {
                        endTime: serverTimestamp(),
                        durationSeconds: durationSeconds,
                        status: 'completed',
                        // ‡¶á‡¶â‡¶ú‡¶æ‡¶∞ ‡¶Ü‡¶á‡¶°‡¶ø ‡¶∏‡ßá‡¶≠ ‡¶ï‡¶∞‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá ‡¶ï‡¶æ‡¶∞‡¶£ ‡¶è‡¶ü‡¶ø ‡¶è‡¶ï‡¶ü‡¶ø ‡¶™‡¶æ‡¶¨‡¶≤‡¶ø‡¶ï ‡¶°‡ßá‡¶ü‡¶æ ‡¶®‡¶Ø‡¶º‡•§
                    });
                    showModal('‡¶∏‡¶´‡¶≤', `‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ${formatSeconds(durationSeconds)} ‡¶™‡¶°‡¶º‡¶æ‡¶∞ ‡¶∏‡¶Æ‡¶Ø‡¶º ‡¶∏‡ßá‡¶≠ ‡¶ï‡¶∞‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá!`, false);
                } catch (error) {
                    console.error("Error saving reading session:", error);
                    showModal('‡¶§‡ßç‡¶∞‡ßÅ‡¶ü‡¶ø', '‡¶™‡¶°‡¶º‡¶æ‡¶∞ ‡¶∏‡ßá‡¶∂‡¶® ‡¶∏‡ßá‡¶≠ ‡¶ï‡¶∞‡¶æ ‡¶Ø‡¶æ‡¶Ø‡¶º‡¶®‡¶ø‡•§', false);
                }
            }
            
            // ‡¶∞‡¶ø‡¶∏‡ßá‡¶ü UI
            timerInterval = null;
            startTime = 0;
            currentReadingRef = null;
            timerDisplay.textContent = '00:00:00';
            timerStartButton.disabled = false;
            timerStopButton.disabled = true;
            timerStartButton.textContent = '‡¶∂‡ßÅ‡¶∞‡ßÅ ‡¶ï‡¶∞‡ßÅ‡¶®';
            timerStartButton.classList.remove('bg-gray-400');
            timerStartButton.classList.add('bg-indigo-600', 'hover:bg-indigo-700');
            timerSubjectSelect.disabled = false;
            timerSubjectSelect.value = ''; // ‡¶°‡ßç‡¶∞‡¶™‡¶°‡¶æ‡¶â‡¶® ‡¶∞‡¶ø‡¶∏‡ßá‡¶ü
        }

        timerStartButton.addEventListener('click', startTimer);
        timerStopButton.addEventListener('click', stopTimer);

        // --- ‡¶™‡¶∞‡¶ø‡¶∏‡¶Ç‡¶ñ‡ßç‡¶Ø‡¶æ‡¶® ‡¶ì ‡¶°‡ßç‡¶Ø‡¶æ‡¶∂‡¶¨‡ßã‡¶∞‡ßç‡¶° (‡ß™. ‡¶ì ‡ß´. ‡¶¶‡ßà‡¶®‡¶ø‡¶ï/‡¶∏‡¶æ‡¶™‡ßç‡¶§‡¶æ‡¶π‡¶ø‡¶ï ‡¶∏‡ßç‡¶ü‡ßç‡¶Ø‡¶æ‡¶ü‡¶∏) ---
        
        function getStartOfWeek(date) {
            const d = new Date(date);
            const day = d.getDay();
            const diff = d.getDate() - day + (day === 0 ? -6 : 1); // ‡¶∏‡ßã‡¶Æ‡¶¨‡¶æ‡¶∞‡¶ï‡ßá ‡¶∏‡¶™‡ßç‡¶§‡¶æ‡¶π‡ßá‡¶∞ ‡¶∂‡ßÅ‡¶∞‡ßÅ ‡¶ß‡¶∞‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá (ISO)
            d.setDate(diff);
            d.setHours(0, 0, 0, 0);
            return d;
        }

        function calculateAndRenderStats() {
            if (allReadingSessions.length === 0) {
                totalReadingTime.textContent = '0 ‡¶ò‡¶£‡ßç‡¶ü‡¶æ';
                dailyReadingTime.textContent = '0 ‡¶Æ‡¶ø‡¶®‡¶ø‡¶ü';
                weeklyReadingTime.textContent = '0 ‡¶ò‡¶£‡ßç‡¶ü‡¶æ';
                updateChart([]);
                return;
            }

            const now = new Date();
            const today = now.toDateString();
            const startOfWeek = getStartOfWeek(now).getTime();

            let totalSeconds = 0;
            let dailySeconds = 0;
            let weeklySeconds = 0;
            
            // 7 ‡¶¶‡¶ø‡¶®‡ßá‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶∞‡ßá ‡¶§‡ßà‡¶∞‡¶ø ‡¶ï‡¶∞‡¶æ (‡¶∏‡ßã‡¶Æ‡¶¨‡¶æ‡¶∞ ‡¶•‡ßá‡¶ï‡ßá ‡¶∞‡¶¨‡¶ø‡¶¨‡¶æ‡¶∞)
            const weeklyData = Array(7).fill(0); 

            allReadingSessions.forEach(session => {
                const duration = session.durationSeconds || 0;
                totalSeconds += duration;
                
                if (session.startTime && session.startTime.toDate) {
                    const sessionDate = session.startTime.toDate();
                    const sessionDay = sessionDate.toDateString();
                    
                    // ‡¶¶‡ßà‡¶®‡¶ø‡¶ï
                    if (sessionDay === today) {
                        dailySeconds += duration;
                    }

                    // ‡¶∏‡¶æ‡¶™‡ßç‡¶§‡¶æ‡¶π‡¶ø‡¶ï (‡¶∏‡ßã‡¶Æ‡¶¨‡¶æ‡¶∞ ‡¶•‡ßá‡¶ï‡ßá)
                    if (sessionDate.getTime() >= startOfWeek) {
                        weeklySeconds += duration;
                        
                        // ‡¶ö‡¶æ‡¶∞‡ßç‡¶ü ‡¶°‡ßá‡¶ü‡¶æ
                        let dayIndex = sessionDate.getDay();
                        // 0 (‡¶∞‡¶¨‡¶ø‡¶¨‡¶æ‡¶∞) -> 6, 1 (‡¶∏‡ßã‡¶Æ‡¶¨‡¶æ‡¶∞) -> 0, ..., 6 (‡¶∂‡¶®‡¶ø‡¶¨‡¶æ‡¶∞) -> 5 
                        dayIndex = (dayIndex === 0) ? 6 : dayIndex - 1;
                        if (dayIndex >= 0 && dayIndex < 7) {
                            weeklyData[dayIndex] += duration; // ‡¶∏‡ßá‡¶ï‡ßá‡¶®‡ßç‡¶°
                        }
                    }
                }
            });

            // ‡¶Æ‡¶ø‡¶®‡¶ø‡¶ü ‡¶ì ‡¶ò‡¶£‡ßç‡¶ü‡¶æ‡¶Ø‡¶º ‡¶∞‡ßÇ‡¶™‡¶æ‡¶®‡ßç‡¶§‡¶∞
            totalReadingTime.textContent = `${secondsToHours(totalSeconds)} ‡¶ò‡¶£‡ßç‡¶ü‡¶æ`;
            dailyReadingTime.textContent = `${Math.floor(dailySeconds / 60)} ‡¶Æ‡¶ø‡¶®‡¶ø‡¶ü`;
            weeklyReadingTime.textContent = `${secondsToHours(weeklySeconds)} ‡¶ò‡¶£‡ßç‡¶ü‡¶æ`;
            
            // ‡¶ö‡¶æ‡¶∞‡ßç‡¶ü ‡¶∞‡ßá‡¶®‡ßç‡¶°‡¶æ‡¶∞
            updateChart(weeklyData.map(s => Math.floor(s / 60))); // ‡¶Æ‡¶ø‡¶®‡¶ø‡¶ü‡ßá ‡¶ö‡¶æ‡¶∞‡ßç‡¶ü ‡¶¶‡ßá‡¶ñ‡¶æ‡¶®‡ßã
        }

        // Chart.js ‡¶∞‡ßá‡¶®‡ßç‡¶°‡¶æ‡¶∞
        function updateChart(data) {
            const ctx = document.getElementById('weeklyActivityChart').getContext('2d');
            const labels = ['‡¶∏‡ßã‡¶Æ', '‡¶Æ‡¶ô‡ßç‡¶ó‡¶≤', '‡¶¨‡ßÅ‡¶ß', '‡¶¨‡ßÉ‡¶π‡¶É', '‡¶∂‡ßÅ‡¶ï‡ßç‡¶∞', '‡¶∂‡¶®‡¶ø', '‡¶∞‡¶¨‡¶ø'];

            if (weeklyChart) {
                weeklyChart.data.datasets[0].data = data;
                weeklyChart.update();
                return;
            }

            weeklyChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: '‡¶™‡¶°‡¶º‡¶æ‡¶∞ ‡¶∏‡¶Æ‡¶Ø‡¶º (‡¶Æ‡¶ø‡¶®‡¶ø‡¶ü)',
                        data: data,
                        backgroundColor: 'rgba(99, 102, 241, 0.8)',
                        borderColor: 'rgb(99, 102, 241)',
                        borderWidth: 1,
                        borderRadius: 6
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { display: false },
                        title: { display: false }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: { display: true, text: '‡¶Æ‡¶ø‡¶®‡¶ø‡¶ü' }
                        }
                    }
                }
            });
        }
        
        // ‡¶≤‡¶ï‡ßç‡¶∑‡ßç‡¶Ø ‡¶∏‡ßá‡¶≠ ‡¶ï‡¶∞‡¶æ
        goalForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const dailyGoal = parseInt(dailyGoalInput.value) || 0;
            const weeklyGoal = parseFloat(weeklyGoalInput.value) || 0;

            if (dailyGoal <= 0 || weeklyGoal <= 0) {
                 showModal('‡¶§‡ßç‡¶∞‡ßÅ‡¶ü‡¶ø', '‡¶≤‡¶ï‡ßç‡¶∑‡ßç‡¶Ø ‡¶Ö‡¶¨‡¶∂‡ßç‡¶Ø‡¶á ‡¶∂‡ßÇ‡¶®‡ßç‡¶Ø‡ßá‡¶∞ ‡¶¨‡ßá‡¶∂‡¶ø ‡¶π‡¶§‡ßá ‡¶π‡¶¨‡ßá‡•§', false);
                 return;
            }

            try {
                // ‚úÖ ‡¶™‡¶æ‡¶• ‡¶†‡¶ø‡¶ï ‡¶ï‡¶∞‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá
                await setDoc(doc(db, `users/${userId}/settings/goals`), { 
                    dailyGoal: dailyGoal, // ‡¶Æ‡¶ø‡¶®‡¶ø‡¶ü‡ßá
                    weeklyGoal: weeklyGoal, // ‡¶ò‡¶£‡ßç‡¶ü‡¶æ‡¶Ø‡¶º
                }, { merge: true });
                showModal('‡¶∏‡¶´‡¶≤', '‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶¶‡ßà‡¶®‡¶ø‡¶ï ‡¶ì ‡¶∏‡¶æ‡¶™‡ßç‡¶§‡¶æ‡¶π‡¶ø‡¶ï ‡¶≤‡¶ï‡ßç‡¶∑‡ßç‡¶Ø ‡¶∏‡¶´‡¶≤‡¶≠‡¶æ‡¶¨‡ßá ‡¶∏‡ßá‡¶ü ‡¶ï‡¶∞‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá‡•§', false);
            } catch (error) {
                console.error("Error setting goals:", error);
                showModal('‡¶§‡ßç‡¶∞‡ßÅ‡¶ü‡¶ø', '‡¶≤‡¶ï‡ßç‡¶∑‡ßç‡¶Ø ‡¶∏‡ßá‡¶≠ ‡¶ï‡¶∞‡¶æ ‡¶Ø‡¶æ‡¶Ø‡¶º‡¶®‡¶ø‡•§', false);
            }
        });

        // --- ‡¶ü‡ßÅ-‡¶°‡ßÅ ‡¶∏‡ßç‡¶ü‡¶æ‡¶á‡¶≤ ‡¶∞‡ßÅ‡¶ü‡¶ø‡¶® (‡ß≠. ‡¶∞‡ßÅ‡¶ü‡¶ø‡¶®) ---
        
        // ‡¶∞‡ßÅ‡¶ü‡¶ø‡¶® ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡¶æ
        routineForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const subjectId = routineSubjectSelect.value;
            const duration = parseInt(routineDurationInput.value);

            if (!subjectId || duration <= 0) {
                showModal('‡¶§‡ßç‡¶∞‡ßÅ‡¶ü‡¶ø', '‡¶¨‡¶ø‡¶∑‡¶Ø‡¶º ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® ‡¶ï‡¶∞‡ßÅ‡¶® ‡¶è‡¶¨‡¶Ç ‡¶Æ‡¶ø‡¶®‡¶ø‡¶ü ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡ßÅ‡¶®‡•§', false);
                return;
            }
            
            const subject = allSubjects.find(s => s.id === subjectId);

            try {
                await addDoc(getUserCollectionRef('routines'), {
                    subjectId: subjectId,
                    subjectName: subject.name,
                    durationMinutes: duration,
                    isCompleted: false,
                    date: new Date().toDateString(),
                    createdAt: serverTimestamp()
                });
                routineDurationInput.value = '';
                routineSubjectSelect.value = '';
                showModal('‡¶∏‡¶´‡¶≤', '‡¶∞‡ßÅ‡¶ü‡¶ø‡¶® ‡¶ü‡¶æ‡¶∏‡ßç‡¶ï ‡¶∏‡¶´‡¶≤‡¶≠‡¶æ‡¶¨‡ßá ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá‡•§', false);
            } catch (error) {
                console.error("Error adding routine:", error);
                showModal('‡¶§‡ßç‡¶∞‡ßÅ‡¶ü‡¶ø', '‡¶∞‡ßÅ‡¶ü‡¶ø‡¶® ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡¶æ ‡¶Ø‡¶æ‡¶Ø‡¶º‡¶®‡¶ø‡•§', false);
            }
        });
        
        // ‡¶∞‡ßÅ‡¶ü‡¶ø‡¶® ‡¶∞‡ßá‡¶®‡ßç‡¶°‡¶æ‡¶∞
        function renderRoutineList(routines) {
            routineList.innerHTML = '';
            const todayRoutines = routines.filter(r => r.date === new Date().toDateString());

            if (todayRoutines.length === 0) {
                routineList.innerHTML = '<p class="text-sm text-gray-500">‡¶Ü‡¶ú‡¶ï‡ßá‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶ï‡ßã‡¶®‡ßã ‡¶∞‡ßÅ‡¶ü‡¶ø‡¶® ‡¶∏‡ßá‡¶ü ‡¶ï‡¶∞‡¶æ ‡¶®‡ßá‡¶á‡•§</p>';
                return;
            }

            todayRoutines.forEach(routine => {
                const isCompleted = routine.isCompleted;
                const routineHtml = `
                    <div class="flex items-center justify-between p-3 rounded-lg ${isCompleted ? 'bg-green-100' : 'bg-indigo-100'}">
                        <div class="flex items-center">
                            <input type="checkbox" data-routine-id="${routine.id}" ${isCompleted ? 'checked' : ''} class="routine-checkbox h-4 w-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500">
                            <span class="ml-3 text-sm font-medium ${isCompleted ? 'line-through text-gray-500' : 'text-gray-800'}">
                                ${routine.subjectName} - ${routine.durationMinutes} ‡¶Æ‡¶ø‡¶®‡¶ø‡¶ü
                            </span>
                        </div>
                        <button data-routine-id="${routine.id}" class="delete-routine-btn text-red-500 hover:text-red-700 transition duration-150">
                            <i data-lucide="x" class="w-4 h-4"></i>
                        </button>
                    </div>
                `;
                routineList.insertAdjacentHTML('beforeend', routineHtml);
            });
            lucide.createIcons();
        }
        
        // ‡¶∞‡ßÅ‡¶ü‡¶ø‡¶® ‡¶ö‡ßá‡¶ï/‡¶Ü‡¶®‡¶ö‡ßá‡¶ï ‡¶è‡¶¨‡¶Ç ‡¶Æ‡ßÅ‡¶õ‡ßá ‡¶´‡ßá‡¶≤‡¶æ
        routineList.addEventListener('change', async (e) => {
            if (e.target.classList.contains('routine-checkbox')) {
                const routineId = e.target.dataset.routineId;
                const isCompleted = e.target.checked;
                
                try {
                    await updateDoc(doc(getUserCollectionRef('routines'), routineId), {
                        isCompleted: isCompleted,
                        completedAt: isCompleted ? serverTimestamp() : null
                    });
                } catch (error) {
                    console.error("Error updating routine:", error);
                }
            }
        });

        routineList.addEventListener('click', async (e) => {
             if (e.target.closest('.delete-routine-btn')) {
                const routineId = e.target.closest('.delete-routine-btn').dataset.routineId;
                
                showModal('‡¶Æ‡ßÅ‡¶õ‡ßá ‡¶´‡ßá‡¶≤‡¶æ ‡¶π‡¶¨‡ßá?', '‡¶Ü‡¶™‡¶®‡¶ø ‡¶ï‡¶ø ‡¶®‡¶ø‡¶∂‡ßç‡¶ö‡¶ø‡¶§ ‡¶è‡¶á ‡¶∞‡ßÅ‡¶ü‡¶ø‡¶® ‡¶ü‡¶æ‡¶∏‡ßç‡¶ï‡¶ü‡¶ø ‡¶Æ‡ßÅ‡¶õ‡ßá ‡¶´‡ßá‡¶≤‡¶§‡ßá ‡¶ö‡¶æ‡¶®?', true, async () => {
                    try {
                        await deleteDoc(doc(getUserCollectionRef('routines'), routineId));
                        showModal('‡¶∏‡¶´‡¶≤', '‡¶∞‡ßÅ‡¶ü‡¶ø‡¶® ‡¶ü‡¶æ‡¶∏‡ßç‡¶ï ‡¶Æ‡ßÅ‡¶õ‡ßá ‡¶´‡ßá‡¶≤‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá‡•§', false);
                    } catch (error) {
                        console.error("Error deleting routine:", error);
                        showModal('‡¶§‡ßç‡¶∞‡ßÅ‡¶ü‡¶ø', '‡¶∞‡ßÅ‡¶ü‡¶ø‡¶® ‡¶ü‡¶æ‡¶∏‡ßç‡¶ï ‡¶Æ‡ßÅ‡¶õ‡ßá ‡¶´‡ßá‡¶≤‡¶æ ‡¶Ø‡¶æ‡¶Ø‡¶º‡¶®‡¶ø‡•§', false);
                    }
                });
            }
        });

        // --- ‡¶ï‡¶æ‡¶∏‡ßç‡¶ü‡¶Æ ‡¶∞‡¶ø‡¶°‡¶ø‡¶Ç ‡¶™‡ßç‡¶≤‡ßç‡¶Ø‡¶æ‡¶® (‡ß¨. ‡¶™‡ßç‡¶≤‡ßç‡¶Ø‡¶æ‡¶®) ---
        
        planForm.addEventListener('submit', (e) => {
            e.preventDefault();
            
            const subjectId = planSubjectSelect.value;
            const days = parseInt(planDaysInput.value);

            if (!subjectId || days <= 0) {
                showModal('‡¶§‡ßç‡¶∞‡ßÅ‡¶ü‡¶ø', '‡¶¨‡¶ø‡¶∑‡ßü ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® ‡¶ï‡¶∞‡ßÅ‡¶® ‡¶è‡¶¨‡¶Ç ‡¶¶‡¶ø‡¶®‡ßá‡¶∞ ‡¶∏‡¶Ç‡¶ñ‡ßç‡¶Ø‡¶æ ‡¶∂‡ßÇ‡¶®‡ßç‡¶Ø‡ßá‡¶∞ ‡¶¨‡ßá‡¶∂‡¶ø ‡¶π‡¶§‡ßá ‡¶π‡¶¨‡ßá‡•§', false);
                return;
            }

            const subject = allSubjects.find(s => s.id === subjectId);
            const totalChapters = subject.chapters ? subject.chapters.length : 0;
            
            if (totalChapters === 0) {
                planOutput.classList.remove('hidden');
                planDetails.textContent = `‡¶¨‡¶ø‡¶∑‡ßü: ${subject.name}`;
                planDailyChapters.textContent = `‡¶è‡¶á ‡¶¨‡¶ø‡¶∑‡ßü‡ßá ‡¶ï‡ßã‡¶®‡ßã ‡¶Ö‡¶ß‡ßç‡¶Ø‡¶æ‡¶Ø‡¶º ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡¶æ ‡¶®‡ßá‡¶á‡•§`;
                return;
            }

            // ‡¶™‡ßç‡¶∞‡¶§‡¶ø‡¶¶‡¶ø‡¶® ‡¶ï‡¶§‡¶ó‡ßÅ‡¶≤‡ßã ‡¶Ö‡¶ß‡ßç‡¶Ø‡¶æ‡¶Ø‡¶º ‡¶™‡¶°‡¶º‡¶§‡ßá ‡¶π‡¶¨‡ßá ‡¶§‡¶æ‡¶∞ ‡¶π‡¶ø‡¶∏‡¶æ‡¶¨
            const chaptersPerDay = Math.ceil(totalChapters / days);
            
            planOutput.classList.remove('hidden');
            planDetails.textContent = `‡¶¨‡¶ø‡¶∑‡ßü: ${subject.name} | ${days} ‡¶¶‡¶ø‡¶®‡ßá‡¶∞ ‡¶ü‡¶æ‡¶∞‡ßç‡¶ó‡ßá‡¶ü`;
            planDailyChapters.textContent = `‡¶¨‡¶á‡¶ü‡¶ø ${days} ‡¶¶‡¶ø‡¶®‡ßá ‡¶∂‡ßá‡¶∑ ‡¶ï‡¶∞‡¶æ‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶Ü‡¶™‡¶®‡¶æ‡¶ï‡ßá ‡¶™‡ßç‡¶∞‡¶§‡¶ø‡¶¶‡¶ø‡¶® ‡¶ï‡¶Æ‡¶™‡¶ï‡ßç‡¶∑‡ßá ${chaptersPerDay} ‡¶ü‡¶ø ‡¶ï‡¶∞‡ßá ‡¶Ö‡¶ß‡ßç‡¶Ø‡¶æ‡¶Ø‡¶º ‡¶™‡¶°‡¶º‡¶§‡ßá ‡¶π‡¶¨‡ßá‡•§`;
        });
        
        // --- ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶°‡¶Æ‡¶ø‡¶® ‡¶™‡ßç‡¶Ø‡¶æ‡¶®‡ßá‡¶≤ ‡¶≤‡¶ú‡¶ø‡¶ï (‡ßÆ. ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶°‡¶Æ‡¶ø‡¶®) ---
        
        async function loadAdminData() {
            if (userId !== ADMIN_UID) return;

            try {
                // ‡¶∏‡¶ï‡¶≤ ‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞‡¶ï‡¶æ‡¶∞‡ßÄ‡¶∞ ‡¶∏‡ßá‡¶∂‡¶® ‡¶°‡ßá‡¶ü‡¶æ
                // ‚úÖ ‡¶´‡¶æ‡¶Ø‡¶º‡¶æ‡¶∞‡¶∏‡ßç‡¶ü‡ßã‡¶∞ ‡¶™‡¶æ‡¶•‡¶ó‡ßÅ‡¶≤‡¶ø ‡¶∏‡¶π‡¶ú ‡¶è‡¶¨‡¶Ç ‡¶∏‡ßç‡¶ü‡ßç‡¶Ø‡¶æ‡¶®‡ßç‡¶°‡¶æ‡¶∞‡ßç‡¶° ‡¶ï‡¶∞‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá
                const usersSnapshot = await getDocs(collection(db, `users`)); 
                const allUsers = usersSnapshot.docs.map(d => d.id).filter(uid => uid !== ADMIN_UID);
                
                adminUserCount.textContent = allUsers.length;
                let totalReadingSeconds = 0;
                let userReports = [];
                
                // ‡¶™‡ßç‡¶∞‡¶§‡¶ø‡¶ü‡¶ø ‡¶á‡¶â‡¶ú‡¶æ‡¶∞ ‡¶Ü‡¶á‡¶°‡¶ø ‡¶®‡¶ø‡¶Ø‡¶º‡ßá ‡¶°‡ßá‡¶ü‡¶æ ‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡¶æ
                for (const uId of allUsers) {
                    // ‚úÖ ‡¶´‡¶æ‡¶Ø‡¶º‡¶æ‡¶∞‡¶∏‡ßç‡¶ü‡ßã‡¶∞ ‡¶™‡¶æ‡¶•‡¶ó‡ßÅ‡¶≤‡¶ø ‡¶∏‡¶π‡¶ú ‡¶è‡¶¨‡¶Ç ‡¶∏‡ßç‡¶ü‡ßç‡¶Ø‡¶æ‡¶®‡ßç‡¶°‡¶æ‡¶∞‡ßç‡¶° ‡¶ï‡¶∞‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá
                    const sessionsQuery = query(collection(db, `users/${uId}/reading_sessions`)); 
                    const sessionsSnapshot = await getDocs(sessionsQuery);
                    
                    let userTotalSeconds = 0;
                    let lastActivity = '‡¶ï‡ßã‡¶®‡ßã ‡¶°‡ßá‡¶ü‡¶æ ‡¶®‡ßá‡¶á';
                    
                    sessionsSnapshot.forEach(sessionDoc => {
                        const data = sessionDoc.data();
                        userTotalSeconds += (data.durationSeconds || 0);
                        if (data.endTime && data.endTime.toDate) {
                            lastActivity = data.endTime.toDate().toLocaleString('bn-BD');
                        }
                    });
                    
                    totalReadingSeconds += userTotalSeconds;
                    
                    userReports.push({
                        id: uId,
                        totalHours: secondsToHours(userTotalSeconds),
                        lastActivity: lastActivity
                    });
                }
                
                adminTotalHours.textContent = secondsToHours(totalReadingSeconds);
                // ‡¶∏‡¶æ‡¶™‡ßç‡¶§‡¶æ‡¶π‡¶ø‡¶ï ‡¶ó‡¶°‡¶º ‡¶π‡¶ø‡¶∏‡¶æ‡¶¨ (‡¶ñ‡ßÅ‡¶¨ ‡¶∏‡¶∞‡¶≤‡ßÄ‡¶ï‡ßÉ‡¶§)
                adminWeeklyAvg.textContent = `${secondsToHours(totalReadingSeconds / (allUsers.length || 1) / 52)} ‡¶ò‡¶£‡ßç‡¶ü‡¶æ`;
                
                // ‡¶∞‡¶ø‡¶™‡ßã‡¶∞‡ßç‡¶ü ‡¶ü‡ßá‡¶¨‡¶ø‡¶≤ ‡¶∞‡ßá‡¶®‡ßç‡¶°‡¶æ‡¶∞
                renderAdminReportTable(userReports);

            } catch (error) {
                console.error("Error loading Admin Data:", error);
                showModal('‡¶§‡ßç‡¶∞‡ßÅ‡¶ü‡¶ø', '‡¶Ö‡ßç‡¶Ø‡¶æ‡¶°‡¶Æ‡¶ø‡¶® ‡¶°‡ßá‡¶ü‡¶æ ‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡¶æ ‡¶Ø‡¶æ‡¶Ø‡¶º‡¶®‡¶ø‡•§', false);
            }
        }

        // --- ‡¶ü‡ßç‡¶Ø‡¶æ‡¶¨ ‡¶®‡ßá‡¶≠‡¶ø‡¶ó‡ßá‡¶∂‡¶® (‡¶°‡ßç‡¶Ø‡¶æ‡¶∂‡¶¨‡ßã‡¶∞‡ßç‡¶°, ‡¶¨‡¶ø‡¶∑‡¶Ø‡¶º, ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶°‡¶Æ‡¶ø‡¶®) ---

document.querySelectorAll('.tab-button').forEach(btn => {
    btn.addEventListener('click', (e) => {
        const viewName = e.target.dataset.view;
        
        // ‡¶∏‡¶ï‡¶≤ ‡¶≠‡¶ø‡¶â ‡¶≤‡ßÅ‡¶ï‡¶æ‡¶®‡ßã
        document.querySelectorAll('.view-content').forEach(el => {
            el.classList.add('hidden');
        });
        
        // ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶ø‡¶§ ‡¶≠‡¶ø‡¶â ‡¶¶‡ßá‡¶ñ‡¶æ‡¶®‡ßã
        const viewElement = document.getElementById(`${viewName}-view`);
        if (viewElement) {
            viewElement.classList.remove('hidden');
        }
        
        // ‡¶ü‡ßç‡¶Ø‡¶æ‡¶¨ ‡¶∏‡ßç‡¶ü‡¶æ‡¶á‡¶≤ ‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶ï‡¶∞‡¶æ
        document.querySelectorAll('.tab-button').forEach(b => {
            b.classList.remove('border-b-2', 'border-indigo-500', 'text-indigo-600');
            b.classList.add('text-gray-500');
        });
        
        btn.classList.remove('text-gray-500');
        btn.classList.add('border-b-2', 'border-indigo-500', 'text-indigo-600');
    });
});

// Firebase ‡¶è‡¶¨‡¶Ç ‡¶°‡ßá‡¶ü‡¶æ ‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡¶æ‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø initFirebase() ‡¶ï‡¶≤ ‡¶ï‡¶∞‡¶æ
initFirebase();

        function renderAdminReportTable(reports) {
            adminUserReportTable.innerHTML = '';
            reports.sort((a, b) => parseFloat(b.totalHours) - parseFloat(a.totalHours)); // ‡¶Æ‡ßã‡¶ü ‡¶∏‡¶Æ‡¶Ø‡¶º ‡¶Ö‡¶®‡ßÅ‡¶Ø‡¶æ‡¶Ø‡¶º‡ßÄ ‡¶∏‡¶∞‡ßç‡¶ü ‡¶ï‡¶∞‡¶æ
            
            reports.forEach(report => {
                const row = `
                    <tr class="hover:bg-gray-50">
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900 break-all">${report.id}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">${report.totalHours}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${report.lastActivity}</td>
                    </tr>
                `;
                adminUserReportTable.insertAdjacentHTML('beforeend', row);
            });
        }
        
        // --- ‡¶≠‡¶ø‡¶â ‡¶Æ‡ßç‡¶Ø‡¶æ‡¶®‡ßá‡¶ú‡¶Æ‡ßá‡¶®‡ßç‡¶ü ---

        document.querySelectorAll('.tab-button').forEach(button => {
            button.addEventListener('click', (e) => {
                const targetView = e.currentTarget.dataset.view;
                
                // ‡¶ü‡ßç‡¶Ø‡¶æ‡¶¨ ‡¶∏‡ßç‡¶ü‡¶æ‡¶á‡¶≤ ‡¶Ü‡¶™‡¶°‡ßá‡¶ü
                document.querySelectorAll('.tab-button').forEach(btn => {
                    btn.classList.remove('border-indigo-500', 'text-indigo-600');
                    btn.classList.add('text-gray-500', 'hover:text-gray-700', 'hover:border-gray-300');
                    btn.classList.remove('border-b-2');
                });
                e.currentTarget.classList.add('border-b-2', 'border-indigo-500', 'text-indigo-600');
                e.currentTarget.classList.remove('text-gray-500', 'hover:text-gray-700', 'hover:border-gray-300');

                // ‡¶≠‡¶ø‡¶â ‡¶ï‡¶®‡ßç‡¶ü‡ßá‡¶®‡ßç‡¶ü ‡¶Ü‡¶™‡¶°‡ßá‡¶ü
                document.querySelectorAll('.view-content').forEach(view => {
                    view.classList.add('hidden');
                });
                document.getElementById(`${targetView}-view`).classList.remove('hidden');
            });
        });
        
        // ‡¶°‡¶ø‡¶´‡¶≤‡ßç‡¶ü ‡¶≠‡¶ø‡¶â ‡¶∏‡ßá‡¶ü ‡¶ï‡¶∞‡¶æ
        document.querySelector('.tab-button[data-view="dashboard"]').click(); 

        // ‡¶∏‡¶¨ ‡¶ï‡¶ø‡¶õ‡ßÅ ‡¶∂‡ßÅ‡¶∞‡ßÅ ‡¶ï‡¶∞‡¶æ
        initFirebase();
        
        // ‡¶Ü‡¶á‡¶ï‡¶® ‡¶∞‡ßá‡¶®‡ßç‡¶°‡¶æ‡¶∞ ‡¶ï‡¶∞‡¶æ
        lucide.createIcons();
    </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chartjs-plugin-datalabels/2.2.0/chartjs-plugin-datalabels.min.js" xintegrity="sha512-R/cmfskY3K2S8wU7Vp8gX9gC9J0vD3f2e+V6z1qJz5Qe+V9zJz5g4l8Qz5g==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

  <script type="module">
    // -------------------
    // 1Ô∏è‚É£ Import Firebase Modules
    // -------------------
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
    import { getFirestore, collection, addDoc, getDocs, doc, setDoc } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";
    import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-auth.js";

    // -------------------
    // 2Ô∏è‚É£ Firebase Config
    // -------------------
    const firebaseConfig = {
      apiKey: "AIzaSyBcs_LrxMA_aXlZZoQ7SsLztjYU5YktEo8",
      authDomain: "readingprogressapp.firebaseapp.com",
      projectId: "readingprogressapp",
      storageBucket: "readingprogressapp.appspot.com",  // Change . firebasestorage.app to . appspot.com
      messagingSenderId: "212134190518",
      appId: "1:212134190518:web:995a883889f375fc9e7517",
      measurementId: "G-95XJF5XGB5"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    // Expose for testing
    window.db = db;
    window.auth = auth;

    // -------------------
    // 3Ô∏è‚É£ Google Auth
    // -------------------
    const provider = new GoogleAuthProvider();
    provider.setCustomParameters({ prompt: 'select_account' });

    async function loginWithGoogle() {
      try {
        const result = await signInWithPopup(auth, provider);
        const user = result.user;
        console.log("User info:", user);
        alert("Hello " + user.displayName);

        // Save user to Firestore
        const { uid, email, displayName, photoURL } = user;
        await setDoc(doc(db, "users", uid), {
          email,
          displayName,
          photoUrl: photoURL,
          createdAt: new Date()
        });
      } catch (error) {
        console.error("Login failed:", error);
      }
    }

    function logout() {
      signOut(auth);
      alert("Signed out");
    }

    onAuthStateChanged(auth, user => {
      if (user) {
        console.log("Logged in:", user.displayName);
      } else {
        console.log("Logged out");
      }
    });

    document.getElementById("loginBtn").addEventListener("click", loginWithGoogle);
    document.getElementById("logoutBtn").addEventListener("click", logout);

    // -------------------
    // 4Ô∏è‚É£ Firestore Book Operations
    // -------------------
    async function addSampleBook() {
      try {
        const docRef = await addDoc(collection(db, "books"), {
          title: "Atomic Habits",
          author: "James Clear",
          totalPages: 250,
          coverImageUrl: "",
          description: "Self improvement book",
          genre: "Self-help"
        });
        alert("Book added with ID: " + docRef.id);
      } catch (error) {
        console.error("Error adding book: ", error);
      }
    }

    async function listBooks() {
      try {
        const querySnapshot = await getDocs(collection(db, "books"));
        console.clear();
        querySnapshot.forEach((doc) => {
          console.log(doc.id, doc.data());
        });
        alert("Check console for book list");
      } catch (error) {
        console.error("Error listing books: ", error);
      }
    }

    document.getElementById("addBookBtn").addEventListener("click", addSampleBook);
    document.getElementById("listBooksBtn").addEventListener("click", listBooks);

    // -------------------
    // 5Ô∏è‚É£ Reading Sessions & Goals (basic template)
    // -------------------
    async function addReadingSession(userId, bookId) {
      await addDoc(collection(db, "readingSessions"), {
        userId,
        bookId,
        startDate: new Date(),
        currentPage: 0,
        status: "ongoing",
        endDate: null,
        currentPercentage: 0,
        notes: ""
      });
    }

    async function addReadingGoal(userId) {
      await addDoc(collection(db, "readingGoals"), {
        userId,
        goalType: "dailyPages",
        targetValue: 20,
        period: "daily",
        startDate: new Date(),
        endDate: null,
        description: "Read 20 pages daily"
      });
    }

    // =========== PHASE 1: READING STREAKS, CALENDAR, HISTORY ===========

// Global variables for Phase 1
let allStreaks = [];
let streakData = {};
let calendarData = {};
let currentCalendarDate = new Date();
let historyCurrentPage = 1;
let historyItemsPerPage = 10;
let filteredSessions = [];

// UI Elements for Streaks
const currentStreakEl = document.getElementById('current-streak');
const longestStreakEl = document.getElementById('longest-streak');
const totalReadingDaysEl = document.getElementById('total-reading-days');
const streakWarningEl = document.getElementById('streak-warning');
const streakHistoryTable = document.getElementById('streak-history-table');

// UI Elements for Calendar
const calendarMonthYearEl = document.getElementById('calendar-month-year');
const calendarGridEl = document.getElementById('calendar-grid');
const prevMonthBtn = document.getElementById('prev-month-btn');
const nextMonthBtn = document.getElementById('next-month-btn');
const dayDetailsEl = document.getElementById('day-details');

// UI Elements for History
const historySubjectFilterEl = document.getElementById('history-subject-filter');
const historyStartDateEl = document.getElementById('history-start-date');
const historyEndDateEl = document.getElementById('history-end-date');
const historyFilterBtn = document.getElementById('history-filter-btn');
const historyTableBody = document. getElementById('history-table-body');
const historyPrevPageBtn = document.getElementById('history-prev-page');
const historyNextPageBtn = document.getElementById('history-next-page');
const historyPageInfo = document.getElementById('history-page-info');
const historyTotalSessions = document.getElementById('history-total-sessions');
const historyTotalTime = document.getElementById('history-total-time');
const historyAvgSession = document.getElementById('history-avg-session');
const historyLongestSession = document.getElementById('history-longest-session');

// ========== READING STREAKS LOGIC ==========

/** ‡¶ó‡¶§ ‡¶™‡¶°‡¶º‡¶æ‡¶∞ ‡¶∏‡¶Æ‡¶Ø‡¶º ‡¶ö‡ßá‡¶ï ‡¶ï‡¶∞‡ßÅ‡¶® ‡¶è‡¶¨‡¶Ç ‡¶∏‡ßç‡¶ü‡ßç‡¶∞‡¶ø‡¶ï ‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶® */
function calculateStreak() {
    if (allReadingSessions.length === 0) {
        streakData = { current: 0, longest: 0, totalDays: 0, history: [] };
        updateStreakDisplay();
        return;
    }

    // ‡¶∏‡ßá‡¶∂‡¶®‡¶ó‡ßÅ‡¶≤‡¶ø ‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ ‡¶Ö‡¶®‡ßÅ‡¶∏‡¶æ‡¶∞‡ßá ‡¶∏‡¶æ‡¶ú‡¶æ‡¶®
    const sortedSessions = [... allReadingSessions].sort((a, b) => {
        const dateA = a.startTime?. toDate?. () || new Date(0);
        const dateB = b.startTime?.toDate?.() || new Date(0);
        return dateB - dateA;
    });

    // ‡¶™‡ßç‡¶∞‡¶§‡¶ø‡¶ü‡¶ø ‡¶¶‡¶ø‡¶®‡ßá ‡¶Ö‡¶®‡ßç‡¶§‡¶§ ‡¶è‡¶ï‡¶¨‡¶æ‡¶∞ ‡¶™‡¶°‡¶º‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá ‡¶ï‡¶ø‡¶®‡¶æ ‡¶ö‡ßá‡¶ï ‡¶ï‡¶∞‡ßÅ‡¶®
    const readingDays = new Set();
    sortedSessions.forEach(session => {
        if (session.startTime?. toDate) {
            const date = session. startTime.toDate();
            const dateStr = date.toDateString();
            readingDays.add(dateStr);
        }
    });

    const uniqueDates = Array.from(readingDays)
        .map(d => new Date(d))
        .sort((a, b) => b - a);

    // ‡¶∏‡ßç‡¶ü‡ßç‡¶∞‡¶ø‡¶ï ‡¶ó‡¶£‡¶®‡¶æ ‡¶ï‡¶∞‡ßÅ‡¶®
    let currentStreak = 0;
    let longestStreak = 0;
    let tempStreak = 0;

    const today = new Date();
    today.setHours(0, 0, 0, 0);

    for (let i = 0; i < uniqueDates.length; i++) {
        const currentDate = new Date(uniqueDates[i]);
        currentDate.setHours(0, 0, 0, 0);

        if (i === 0) {
            // ‡¶™‡ßç‡¶∞‡¶•‡¶Æ ‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ (‡¶∏‡¶∞‡ßç‡¶¨‡¶∂‡ßá‡¶∑)
            const dayDiff = Math.floor((today - currentDate) / (1000 * 60 * 60 * 24));
            if (dayDiff <= 1) {
                // ‡¶Ü‡¶ú ‡¶¨‡¶æ ‡¶ó‡¶§‡¶ï‡¶æ‡¶≤
                currentStreak = 1;
                tempStreak = 1;
            } else {
                currentStreak = 0;
            }
        } else {
            const prevDate = new Date(uniqueDates[i - 1]);
            prevDate.setHours(0, 0, 0, 0);

            const dayDiff = Math.floor((prevDate - currentDate) / (1000 * 60 * 60 * 24));

            if (dayDiff === 1) {
                // ‡¶™‡¶∞‡¶™‡¶∞ ‡¶¶‡¶ø‡¶®
                tempStreak++;
                if (i === 1) {
                    currentStreak = tempStreak;
                }
            } else {
                // ‡¶∏‡ßç‡¶ü‡ßç‡¶∞‡¶ø‡¶ï ‡¶≠‡¶æ‡¶ô‡ßç‡¶ó‡¶≤‡ßã
                longestStreak = Math.max(longestStreak, tempStreak);
                tempStreak = 1;
            }
        }
    }

    longestStreak = Math.max(longestStreak, tempStreak);
    longestStreak = Math.max(longestStreak, currentStreak);

    streakData = {
        current: currentStreak,
        longest: longestStreak,
        totalDays: uniqueDates.length,
        history: uniqueDates
    };

    updateStreakDisplay();
    checkStreakWarning();
}

/** ‡¶∏‡ßç‡¶ü‡ßç‡¶∞‡¶ø‡¶ï ‡¶°‡¶ø‡¶∏‡¶™‡ßç‡¶≤‡ßá ‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶® */
function updateStreakDisplay() {
    currentStreakEl.textContent = streakData.current || 0;
    longestStreakEl.textContent = streakData.longest || 0;
    totalReadingDaysEl. textContent = streakData.totalDays || 0;
}

/** ‡¶∏‡ßç‡¶ü‡ßç‡¶∞‡¶ø‡¶ï ‡¶∏‡¶§‡¶∞‡ßç‡¶ï‡¶§‡¶æ ‡¶ö‡ßá‡¶ï ‡¶ï‡¶∞‡ßÅ‡¶® */
function checkStreakWarning() {
    const today = new Date();
    today.setHours(0, 0, 0, 0);

    const lastReadingDate = streakData.history? .[0];
    if (! lastReadingDate) {
        streakWarningEl.classList.add('hidden');
        return;
    }

    const lastDate = new Date(lastReadingDate);
    lastDate.setHours(0, 0, 0, 0);

    const dayDiff = Math.floor((today - lastDate) / (1000 * 60 * 60 * 24));

    if (dayDiff === 1 && streakData.current > 0) {
        streakWarningEl.classList.remove('hidden');
    } else {
        streakWarningEl. classList.add('hidden');
    }
}

// ========== READING CALENDAR LOGIC ==========

/** ‡¶ï‡ßç‡¶Ø‡¶æ‡¶≤‡ßá‡¶®‡ßç‡¶°‡¶æ‡¶∞ ‡¶∞‡ßá‡¶®‡ßç‡¶°‡¶æ‡¶∞ ‡¶ï‡¶∞‡ßÅ‡¶® */
function renderCalendar() {
    const year = currentCalendarDate.getFullYear();
    const month = currentCalendarDate.getMonth();

    // ‡¶Æ‡¶æ‡¶∏ ‡¶è‡¶¨‡¶Ç ‡¶¨‡¶õ‡¶∞ ‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®
    const monthNames = ['‡¶ú‡¶æ‡¶®‡ßÅ‡¶Ø‡¶º‡¶æ‡¶∞‡¶ø', '‡¶´‡ßá‡¶¨‡ßç‡¶∞‡ßÅ‡¶Ø‡¶º‡¶æ‡¶∞‡¶ø', '‡¶Æ‡¶æ‡¶∞‡ßç‡¶ö', '‡¶è‡¶™‡ßç‡¶∞‡¶ø‡¶≤', '‡¶Æ‡ßá', '‡¶ú‡ßÅ‡¶®', '‡¶ú‡ßÅ‡¶≤‡¶æ‡¶á', '‡¶Ü‡¶ó‡¶∏‡ßç‡¶ü', '‡¶∏‡ßá‡¶™‡ßç‡¶ü‡ßá‡¶Æ‡ßç‡¶¨‡¶∞', '‡¶Ö‡¶ï‡ßç‡¶ü‡ßã‡¶¨‡¶∞', '‡¶®‡¶≠‡ßá‡¶Æ‡ßç‡¶¨‡¶∞', '‡¶°‡¶ø‡¶∏‡ßá‡¶Æ‡ßç‡¶¨‡¶∞'];
    calendarMonthYearEl.textContent = `${monthNames[month]} ${year}`;

    // ‡¶™‡ßç‡¶∞‡¶•‡¶Æ ‡¶¶‡¶ø‡¶® ‡¶è‡¶¨‡¶Ç ‡¶¶‡¶ø‡¶® ‡¶∏‡¶Ç‡¶ñ‡ßç‡¶Ø‡¶æ ‡¶™‡¶æ‡¶®
    const firstDay = new Date(year, month, 1). getDay();
    const daysInMonth = new Date(year, month + 1, 0). getDate();
    const daysInPrevMonth = new Date(year, month, 0).getDate();

    calendarGridEl.innerHTML = '';

    // ‡¶ó‡¶§ ‡¶Æ‡¶æ‡¶∏‡ßá‡¶∞ ‡¶¶‡¶ø‡¶®‡¶ó‡ßÅ‡¶≤‡¶ø (‡¶ó‡ßç‡¶∞‡ßá)
    for (let i = firstDay - 1; i >= 0; i--) {
        const day = daysInPrevMonth - i;
        const dayEl = createCalendarDayElement(day, 'prev', null);
        calendarGridEl. appendChild(dayEl);
    }

    // ‡¶¨‡¶∞‡ßç‡¶§‡¶Æ‡¶æ‡¶® ‡¶Æ‡¶æ‡¶∏‡ßá‡¶∞ ‡¶¶‡¶ø‡¶®‡¶ó‡ßÅ‡¶≤‡¶ø
    for (let day = 1; day <= daysInMonth; day++) {
        const dateStr = new Date(year, month, day).toDateString();
        const readingTime = calendarData[dateStr]?.totalSeconds || 0;
        const dayEl = createCalendarDayElement(day, 'current', { dateStr, readingTime });
        calendarGridEl.appendChild(dayEl);
    }

    // ‡¶™‡¶∞‡¶¨‡¶∞‡ßç‡¶§‡ßÄ ‡¶Æ‡¶æ‡¶∏‡ßá‡¶∞ ‡¶¶‡¶ø‡¶®‡¶ó‡ßÅ‡¶≤‡¶ø (‡¶ó‡ßç‡¶∞‡ßá)
    const totalCells = calendarGridEl.children.length;
    const remainingCells = 42 - totalCells; // 6 ‡¶∏‡¶™‡ßç‡¶§‡¶æ‡¶π √ó 7 ‡¶¶‡¶ø‡¶®
    for (let day = 1; day <= remainingCells; day++) {
        const dayEl = createCalendarDayElement(day, 'next', null);
        calendarGridEl. appendChild(dayEl);
    }
}

/** ‡¶ï‡ßç‡¶Ø‡¶æ‡¶≤‡ßá‡¶®‡ßç‡¶°‡¶æ‡¶∞‡ßá‡¶∞ ‡¶¶‡¶ø‡¶® ‡¶â‡¶™‡¶æ‡¶¶‡¶æ‡¶® ‡¶§‡ßà‡¶∞‡¶ø ‡¶ï‡¶∞‡ßÅ‡¶® */
function createCalendarDayElement(day, type, data) {
    const dayEl = document.createElement('div');
    dayEl.className = 'p-2 rounded text-center text-sm font-medium cursor-pointer transition';

    if (type === 'prev' || type === 'next') {
        dayEl.className += ' text-gray-400 bg-gray-100 opacity-50';
        dayEl.textContent = day;
    } else {
        dayEl.textContent = day;

        if (data. readingTime > 0) {
            if (data.readingTime >= 60 * 60) { // >= 1 ‡¶ò‡¶£‡ßç‡¶ü‡¶æ
                dayEl.className += ' bg-green-500 text-white hover:bg-green-600';
            } else {
                dayEl.className += ' bg-yellow-400 text-white hover:bg-yellow-500';
            }
        } else {
            dayEl.className += ' bg-red-400 text-white hover:bg-red-500';
        }

        dayEl.addEventListener('click', () => {
            showDayDetails(data.dateStr);
        });
    }

    return dayEl;
}

/** ‡¶¶‡¶ø‡¶®‡ßá‡¶∞ ‡¶¨‡¶ø‡¶¨‡¶∞‡¶£ ‡¶¶‡ßá‡¶ñ‡¶æ‡¶® */
function showDayDetails(dateStr) {
    const dayData = calendarData[dateStr];
    if (dayData) {
        const hours = Math.floor(dayData.totalSeconds / 3600);
        const minutes = Math.floor((dayData.totalSeconds % 3600) / 60);

        document.getElementById('day-reading-time').innerHTML = 
            `‡¶™‡¶°‡¶º‡¶æ‡¶∞ ‡¶∏‡¶Æ‡¶Ø‡¶º: <span class="font-semibold">${hours} ‡¶ò‡¶£‡ßç‡¶ü‡¶æ ${minutes} ‡¶Æ‡¶ø‡¶®‡¶ø‡¶ü</span>`;
        document.getElementById('day-sessions').innerHTML = 
            `‡¶∏‡ßá‡¶∂‡¶® ‡¶∏‡¶Ç‡¶ñ‡ßç‡¶Ø‡¶æ: <span class="font-semibold">${dayData.sessions || 0}</span>`;

        dayDetailsEl.classList.remove('hidden');
    }
}

/** ‡¶ï‡ßç‡¶Ø‡¶æ‡¶≤‡ßá‡¶®‡ßç‡¶°‡¶æ‡¶∞ ‡¶°‡ßá‡¶ü‡¶æ ‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶® */
function updateCalendarData() {
    calendarData = {};

    allReadingSessions.forEach(session => {
        if (session.startTime?. toDate) {
            const date = session.startTime.toDate();
            const dateStr = date.toDateString();

            if (!calendarData[dateStr]) {
                calendarData[dateStr] = { totalSeconds: 0, sessions: 0 };
            }

            calendarData[dateStr].totalSeconds += session. durationSeconds || 0;
            calendarData[dateStr].sessions += 1;
        }
    });

    renderCalendar();
}

// ========== READING HISTORY LOGIC ==========

/** ‡¶á‡¶§‡¶ø‡¶π‡¶æ‡¶∏ ‡¶´‡¶ø‡¶≤‡ßç‡¶ü‡¶æ‡¶∞ ‡¶è‡¶¨‡¶Ç ‡¶∞‡ßá‡¶®‡ßç‡¶°‡¶æ‡¶∞ ‡¶ï‡¶∞‡ßÅ‡¶® */
function filterAndRenderHistory() {
    const subjectFilter = historySubjectFilterEl.value;
    const startDate = historyStartDateEl.value ?  new Date(historyStartDateEl.value) : null;
    const endDate = historyEndDateEl.value ? new Date(historyEndDateEl. value) : null;

    // ‡¶´‡¶ø‡¶≤‡ßç‡¶ü‡¶æ‡¶∞ ‡¶™‡ßç‡¶∞‡¶Ø‡¶º‡ßã‡¶ó ‡¶ï‡¶∞‡ßÅ‡¶®
    filteredSessions = allReadingSessions.filter(session => {
        // ‡¶¨‡¶ø‡¶∑‡¶Ø‡¶º ‡¶´‡¶ø‡¶≤‡ßç‡¶ü‡¶æ‡¶∞
        if (subjectFilter && session.subjectChapter !== subjectFilter) {
            return false;
        }

        // ‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ ‡¶´‡¶ø‡¶≤‡ßç‡¶ü‡¶æ‡¶∞
        if (session.startTime?.toDate) {
            const sessionDate = session.startTime.toDate();
            if (startDate && sessionDate < startDate) return false;
            if (endDate) {
                endDate.setHours(23, 59, 59, 999);
                if (sessionDate > endDate) return false;
            }
        }

        return true;
    });

    // ‡¶∏‡¶æ‡¶ú‡¶æ‡¶® (‡¶∏‡¶∞‡ßç‡¶¨‡¶∂‡ßá‡¶∑ ‡¶™‡ßç‡¶∞‡¶•‡¶Æ)
    filteredSessions.sort((a, b) => {
        const dateA = a.startTime?.toDate?. () || new Date(0);
        const dateB = b.startTime?.toDate?.() || new Date(0);
        return dateB - dateA;
    });

    // ‡¶™‡¶∞‡¶ø‡¶∏‡¶Ç‡¶ñ‡ßç‡¶Ø‡¶æ‡¶® ‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®
    updateHistoryStats();

    // ‡¶™‡ßá‡¶ú ‡¶∞‡¶ø‡¶∏‡ßá‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶® ‡¶è‡¶¨‡¶Ç ‡¶∞‡ßá‡¶®‡ßç‡¶°‡¶æ‡¶∞ ‡¶ï‡¶∞‡ßÅ‡¶®
    historyCurrentPage = 1;
    renderHistoryTable();
}

/** ‡¶á‡¶§‡¶ø‡¶π‡¶æ‡¶∏ ‡¶™‡¶∞‡¶ø‡¶∏‡¶Ç‡¶ñ‡ßç‡¶Ø‡¶æ‡¶® ‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶® */
function updateHistoryStats() {
    if (filteredSessions.length === 0) {
        historyTotalSessions.textContent = '0';
        historyTotalTime.textContent = '0 ‡¶ò';
        historyAvgSession.textContent = '0 ‡¶Æ‡¶ø';
        historyLongestSession.textContent = '0 ‡¶Æ‡¶ø';
        return;
    }

    let totalSeconds = 0;
    let maxSeconds = 0;

    filteredSessions.forEach(session => {
        const duration = session.durationSeconds || 0;
        totalSeconds += duration;
        maxSeconds = Math. max(maxSeconds, duration);
    });

    const totalHours = Math.floor(totalSeconds / 3600);
    const avgMinutes = Math.floor(totalSeconds / 60 / filteredSessions.length);
    const maxMinutes = Math.floor(maxSeconds / 60);

    historyTotalSessions.textContent = filteredSessions.length;
    historyTotalTime.textContent = `${totalHours} ‡¶ò`;
    historyAvgSession. textContent = `${avgMinutes} ‡¶Æ‡¶ø`;
    historyLongestSession.textContent = `${maxMinutes} ‡¶Æ‡¶ø`;
}

/** ‡¶á‡¶§‡¶ø‡¶π‡¶æ‡¶∏ ‡¶ü‡ßá‡¶¨‡¶ø‡¶≤ ‡¶∞‡ßá‡¶®‡ßç‡¶°‡¶æ‡¶∞ ‡¶ï‡¶∞‡ßÅ‡¶® */
function renderHistoryTable() {
    if (filteredSessions.length === 0) {
        historyTableBody.innerHTML = '<tr><td colspan="5" class="px-4 py-8 text-center text-gray-500">‡¶ï‡ßã‡¶®‡ßã ‡¶∞‡ßá‡¶ï‡¶∞‡ßç‡¶° ‡¶®‡ßá‡¶á</td></tr>';
        historyPrevPageBtn.disabled = true;
        historyNextPageBtn.disabled = true;
        return;
    }

    const startIdx = (historyCurrentPage - 1) * historyItemsPerPage;
    const endIdx = startIdx + historyItemsPerPage;
    const paginatedSessions = filteredSessions.slice(startIdx, endIdx);

    historyTableBody.innerHTML = '';

    paginatedSessions.forEach((session, idx) => {
        const date = session.startTime?.toDate ?  session.startTime.toDate() : new Date();
        const duration = session.durationSeconds || 0;
        const minutes = Math.floor(duration / 60);
        const seconds = duration % 60;
        const startTime = date.toLocaleTimeString('bn-BD', { hour: '2-digit', minute: '2-digit' });

        // ‡¶¨‡¶ø‡¶∑‡¶Ø‡¶º ‡¶®‡¶æ‡¶Æ ‡¶™‡¶æ‡¶®
        let subjectName = session.subjectChapter;
        if (session.subjectChapter?. includes('_')) {
            const [subjectId, chapterIdx] = session.subjectChapter.split('_');
            const subject = allSubjects.find(s => s.id === subjectId);
            if (subject) {
                subjectName = `${subject.name} > ${subject.chapters? .[chapterIdx] || '‡¶Ö‡¶ß‡ßç‡¶Ø‡¶æ‡¶Ø‡¶º'}`;
            }
        }

        const row = `
            <tr class="border-b border-gray-200 hover:bg-gray-50">
                <td class="px-4 py-3 text-sm">${date.toLocaleDateString('bn-BD')}</td>
                <td class="px-4 py-3 text-sm text-gray-700">${subjectName}</td>
                <td class="px-4 py-3 text-sm">${startTime}</td>
                <td class="px-4 py-3 text-sm font-medium">${minutes}‡¶Æ‡¶ø ${seconds}‡¶∏</td>
                <td class="px-4 py-3 text-center">
                    <button class="text-red-500 hover:text-red-700 text-xs font-medium delete-history-btn" data-session-id="${session.id}">
                        ‡¶Æ‡ßÅ‡¶õ‡ßÅ‡¶®
                    </button>
                </td>
            </tr>
        `;
        historyTableBody.insertAdjacentHTML('beforeend', row);
    });

    // ‡¶Æ‡ßÅ‡¶õ‡¶æ‡¶∞ ‡¶¨‡¶æ‡¶ü‡¶® ‡¶á‡¶≠‡ßá‡¶®‡ßç‡¶ü ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡ßÅ‡¶®
    document.querySelectorAll('.delete-history-btn').forEach(btn => {
        btn.addEventListener('click', async (e) => {
            const sessionId = e.target.dataset.sessionId;
            deleteHistorySession(sessionId);
        });
    });

    // ‡¶™‡ßá‡¶ú‡¶ø‡¶®‡ßá‡¶∂‡¶® ‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®
    const totalPages = Math.ceil(filteredSessions.length / historyItemsPerPage);
    historyPageInfo.textContent = `‡¶™‡ßÉ‡¶∑‡ßç‡¶†‡¶æ ${historyCurrentPage} / ${totalPages}`;
    historyPrevPageBtn.disabled = historyCurrentPage === 1;
    historyNextPageBtn. disabled = historyCurrentPage === totalPages;
}

/** ‡¶á‡¶§‡¶ø‡¶π‡¶æ‡¶∏ ‡¶∏‡ßá‡¶∂‡¶® ‡¶Æ‡ßÅ‡¶õ‡ßÅ‡¶® */
async function deleteHistorySession(sessionId) {
    showModal('‡¶®‡¶ø‡¶∂‡ßç‡¶ö‡¶ø‡¶§ ‡¶ï‡¶∞‡ßÅ‡¶®', '‡¶è‡¶á ‡¶∏‡ßá‡¶∂‡¶®‡¶ü‡¶ø ‡¶Æ‡ßÅ‡¶õ‡ßá ‡¶´‡ßá‡¶≤‡¶§‡ßá ‡¶ö‡¶æ‡¶®?', true, async () => {
        try {
            await deleteDoc(doc(getUserCollectionRef('reading_sessions'), sessionId));
            showModal('‡¶∏‡¶´‡¶≤', '‡¶∏‡ßá‡¶∂‡¶®‡¶ü‡¶ø ‡¶Æ‡ßÅ‡¶õ‡ßá ‡¶´‡ßá‡¶≤‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá‡•§', false);
        } catch (error) {
            console.error('Error deleting session:', error);
            showModal('‡¶§‡ßç‡¶∞‡ßÅ‡¶ü‡¶ø', '‡¶∏‡ßá‡¶∂‡¶® ‡¶Æ‡ßÅ‡¶õ‡¶§‡ßá ‡¶¨‡ßç‡¶Ø‡¶∞‡ßç‡¶• ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá‡•§', false);
        }
    });
}

// ========== EVENT LISTENERS ==========

// Calendar Navigation
prevMonthBtn.addEventListener('click', () => {
    currentCalendarDate.setMonth(currentCalendarDate.getMonth() - 1);
    renderCalendar();
});

nextMonthBtn.addEventListener('click', () => {
    currentCalendarDate.setMonth(currentCalendarDate.getMonth() + 1);
    renderCalendar();
});

// History Filter
historyFilterBtn.addEventListener('click', filterAndRenderHistory);

historyPrevPageBtn.addEventListener('click', () => {
    if (historyCurrentPage > 1) {
        historyCurrentPage--;
        renderHistoryTable();
    }
});

historyNextPageBtn.addEventListener('click', () => {
    const totalPages = Math.ceil(filteredSessions.length / historyItemsPerPage);
    if (historyCurrentPage < totalPages) {
        historyCurrentPage++;
        renderHistoryTable();
    }
});

// Populate subject filter
function populateHistorySubjectFilter() {
    historySubjectFilterEl.innerHTML = '<option value="">‡¶∏‡¶¨ ‡¶¨‡¶ø‡¶∑‡¶Ø‡¶º</option>';
    allSubjects.forEach(subject => {
        historySubjectFilterEl.insertAdjacentHTML('beforeend', 
            `<option value="${subject.id}">${subject.name}</option>`
        );
    });
}

// ========== INTEGRATION WITH EXISTING CODE ==========

// loadUserData() ‡¶è‡¶∞ ‡¶Æ‡¶ß‡ßç‡¶Ø‡ßá ‡¶è‡¶á ‡¶≤‡¶æ‡¶á‡¶® ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡ßÅ‡¶®:
// calculateStreak();
// updateCalendarData();
// populateHistorySubjectFilter();
// filterAndRenderHistory();

// calculateAndRenderStats() ‡¶è‡¶∞ ‡¶™‡¶∞‡ßá ‡¶ï‡¶≤ ‡¶ï‡¶∞‡ßÅ‡¶®:
// calculateStreak();
// updateCalendarData();
// filterAndRenderHistory();

// ========== TAB NAVIGATION ==========
document.querySelectorAll('.tab-button').forEach(btn => {
    btn.addEventListener('click', () => {
        const viewName = btn.dataset.view;
        
        // ‡¶∏‡¶¨ ‡¶≠‡¶ø‡¶â ‡¶≤‡ßÅ‡¶ï‡¶æ‡¶®
        document.querySelectorAll('.view-content').forEach(el => el.classList.add('hidden'));
        
        // ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶ø‡¶§ ‡¶≠‡¶ø‡¶â ‡¶¶‡ßá‡¶ñ‡¶æ‡¶®
        const selectedView = document.getElementById(viewName);
        if (selectedView) {
            selectedView. classList.remove('hidden');
        }
        
        // ‡¶∏‡¶¨ ‡¶ü‡ßç‡¶Ø‡¶æ‡¶¨ ‡¶°‡¶ø‡¶Ö‡ßç‡¶Ø‡¶æ‡¶ï‡ßç‡¶ü‡¶ø‡¶≠ ‡¶ï‡¶∞‡ßÅ‡¶®
        document.querySelectorAll('.tab-button').forEach(b => {
            b.classList.remove('border-b-2', 'border-indigo-500', 'text-indigo-600');
            b.classList.add('text-gray-500', 'hover:text-gray-700');
        });
        
        // ‡¶è‡¶á ‡¶ü‡ßç‡¶Ø‡¶æ‡¶¨ ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶ï‡ßç‡¶ü‡¶ø‡¶≠ ‡¶ï‡¶∞‡ßÅ‡¶®
        btn.classList.remove('text-gray-500', 'hover:text-gray-700');
        btn.classList.add('border-b-2', 'border-indigo-500', 'text-indigo-600');
        
        // Lucide ‡¶Ü‡¶á‡¶ï‡¶® ‡¶∞‡ßá‡¶®‡ßç‡¶°‡¶æ‡¶∞ ‡¶ï‡¶∞‡ßÅ‡¶®
        lucide. createIcons();
    });
});

// Dashboard ‡¶ü‡ßç‡¶Ø‡¶æ‡¶¨ default select ‡¶ï‡¶∞‡ßÅ‡¶®
document.querySelector('[data-view="dashboard"]'). click();


  </script>


</body>
</html>
